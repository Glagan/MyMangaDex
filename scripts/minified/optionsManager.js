const LOG={INFO:"info",DANGER:"danger",WARNING:"warning",SUCCESS:"success"};class OptionsManager{constructor(){this.addColorButton=document.getElementById("addColor"),this.saveButton=document.getElementById("save"),this.lastOpenColorsList=document.getElementById("lastOpenColors"),this.defaultLastOpenColors=document.getElementById("defaultLastOpenColors"),this.refreshSaveButton=document.getElementById("refresh-save"),this.saveContent=document.getElementById("save-content"),this.importMMDForm=document.getElementById("save-import"),this.importMALForm=document.getElementById("mal-import"),this.deleteSaveButton=document.getElementById("delete-save"),this.contentNode=document.getElementById("content"),this.lastOpenColorsNodes={},this.outputMyAnimeList=document.getElementById("malImportStatus"),this.importInformations=document.getElementById("importInformations"),this.importSubmitButton=document.getElementById("importSubmitButton"),this.options={},this.myAnimeListMangaList={},this.mangaDexMangaList=[],this.setEvents(),this.start()}async start(){this.options=await loadOptions(),this.restoreOptions()}setEvents(){document.querySelectorAll("[data-color]").forEach(a=>{let b=a.dataset.option;["input","change","cut","paste","keyup"].forEach(function(c){a.addEventListener(c,a=>{document.querySelector("[data-color='"+b+"']").style.backgroundColor=a.target.value})})}),document.querySelectorAll("[data-type='checkbox']").forEach(a=>{let b=a.getElementsByTagName("button");b[0].addEventListener("click",()=>{this.updateCheckbox(a,!0)}),b[1].addEventListener("click",()=>{this.updateCheckbox(a,!1)})}),this.addColorButton.addEventListener("click",()=>{this.addColor()}),this.saveButton.addEventListener("click",()=>{this.saveOptions()}),document.querySelectorAll("[data-default]").forEach(a=>{a.addEventListener("click",()=>{let b=document.querySelector("[data-option='"+a.dataset.default+"']");"type"in b.dataset&&"checkbox"==b.dataset.type?this.updateCheckbox(b,defaultOptions[a.dataset.default]):(b.value=defaultOptions[a.dataset.default],b.dataset.color!==void 0&&(document.querySelector("[data-color='"+a.dataset.default+"']").style.backgroundColor=defaultOptions[a.dataset.default]))})}),this.defaultLastOpenColors.addEventListener("click",()=>{this.restoreDefaultsLastOpenColors()}),this.refreshSaveButton.addEventListener("click",async()=>{let a=await storageGet(null);this.saveContent.value=JSON.stringify(a)}),this.saveContent.addEventListener("click",a=>{a.target.select()}),this.importMMDForm.addEventListener("submit",a=>{a.preventDefault(),this.importMMD()}),this.importMALForm.addEventListener("submit",a=>{a.preventDefault(),this.importMAL()}),this.deleteSaveButton.addEventListener("click",()=>{this.deleteSave()})}async restoreOptions(){let a=this.options.lastOpenColors;this.deleteLastOpenColors(),a.forEach(a=>{this.addColor(a)}),document.querySelectorAll("[data-option]").forEach(a=>{a.dataset.type!==void 0&&"checkbox"==a.dataset.type?this.updateCheckbox(a,this.options[a.dataset.option]):(a.value=this.options[a.dataset.option],a.dataset.color!==void 0&&(document.querySelector("[data-color='"+a.dataset.option+"']").style.backgroundColor=a.value))})}addColor(a=""){let b=uniqueGUID();for(;this.lastOpenColorsNodes[b]!==void 0;)b=uniqueGUID();let c=document.createElement("div");c.className="col px-0 pb-2 my-auto input-group";let d=document.createElement("div");d.className="input-group-prepend";let e=document.createElement("i");e.className="fas fa-trash";let f=document.createElement("a");f.className="btn btn-danger input-prepend",f.appendChild(e),f.appendChild(document.createTextNode(" Remove")),f.addEventListener("click",()=>{this.removeColor(b)}),d.appendChild(f),c.appendChild(d);let g=document.createElement("div");g.className="input-group-append";let h=document.createElement("span");h.className="input-group-text",h.style.backgroundColor=a,g.appendChild(h);let i=document.createElement("input");["input","change","cut","paste","keyup"].forEach(function(a){i.addEventListener(a,a=>{h.style.backgroundColor=a.target.value})}),i.type="text",i.className="form-control",i.value=a,this.lastOpenColorsNodes[b]={parent:c,input:i},c.appendChild(i),c.appendChild(g),this.lastOpenColorsList.insertBefore(c,this.lastOpenColorsList.lastElementChild)}removeColor(a){1<Object.keys(this.lastOpenColorsNodes).length&&(this.lastOpenColorsList.removeChild(this.lastOpenColorsNodes[a].parent),delete this.lastOpenColorsNodes[a])}deleteLastOpenColors(){for(;this.lastOpenColorsList.firstChild&&!("addColorRow"==this.lastOpenColorsList.firstChild.id);)this.lastOpenColorsList.removeChild(this.lastOpenColorsList.firstChild);this.lastOpenColorsNodes={}}restoreDefaultsLastOpenColors(){this.deleteLastOpenColors(),defaultOptions.lastOpenColors.forEach(a=>{this.addColor(a)})}updateCheckbox(a,b){a.dataset.value=b;let c=a.firstElementChild.firstElementChild,d=a.lastElementChild.lastElementChild;b?(c.classList.add("btn-success"),c.classList.remove("btn-secondary"),d.classList.add("btn-secondary"),d.classList.remove("btn-danger")):(c.classList.add("btn-secondary"),c.classList.remove("btn-success"),d.classList.add("btn-danger"),d.classList.remove("btn-secondary"))}flashBackground(a){this.contentNode.classList.add(a?"bg-success":"bg-fail"),setTimeout(()=>{this.contentNode.classList.remove(a?"bg-success":"bg-fail")},500)}async saveOptions(){try{this.options.lastOpenColors=[],Object.keys(this.lastOpenColorsNodes).forEach(a=>{this.options.lastOpenColors.push(this.lastOpenColorsNodes[a].input.value)}),document.querySelectorAll("[data-option]").forEach(a=>{this.options[a.dataset.option]="type"in a.dataset&&"checkbox"==a.dataset.type?"true"==a.dataset.value:a.value}),await storageSet("options",this.options),console.log("Saved"),this.flashBackground(!0)}catch(a){console.error(a),this.flashBackground(!1)}}async deleteSave(){await browser.storage.local.clear();try{await storageSet("options",defaultOptions),this.options=JSON.parse(JSON.stringify(defaultOptions)),this.flashBackground(!0),this.restoreOptions()}catch(a){console.error(a),this.flashBackground(!1)}}logAndScroll(a,b){let c=document.createElement("li");c.className="list-group-item list-group-item-"+a,c.textContent=b,this.outputMyAnimeList.appendChild(c),this.outputMyAnimeList.scrollTop=this.outputMyAnimeList.scrollHeight}async importMMD(){try{this.importSubmitButton.disabled=!0;let a=JSON.parse(this.importMMDForm.save.value);if(isEmpty(a)||void 0===a.options)return this.importInformations.textContent="Invalid save.",this.importSubmitButton.disabled=!1,void this.flashBackground(!1);this.importInformations.textContent="Entries in the save: "+(Object.keys(a).length-1);await storageSet(null,a),this.options=await loadOptions(),await this.restoreOptions(),this.flashBackground(!0),this.importSubmitButton.disabled=!1,this.importMMDForm.save.value=""}catch(a){this.importSubmitButton.disabled=!1,this.flashBackground(!1),console.error(a)}}async importMAL(){let a=this.importMALForm.username.value;this.importMALForm.disabled=!0,""==a?(this.flashBackground(!1),console.error("Empty MAL username")):(this.myAnimeListMangaList={},this.mangaDexMangaList=[],this.outputMyAnimeList.style.display="block",clearDomNode(this.outputMyAnimeList),this.logAndScroll(LOG.INFO,"Starting... don't close this tab."),await this.listMyAnimeList(a,0,!0),0==Object.keys(this.myAnimeListMangaList).length?(this.flashBackground(!1),this.logAndScroll(LOG.DANGER,"Empty MAL manga list, aborting.")):(await this.listMyAnimeList(a,Object.keys(this.myAnimeListMangaList).length),await this.listMangaDex(),await this.updateLocalFromMDMAL(),this.flashBackground(!0)))}async listMyAnimeList(a,b=0,c=!1){if(0<b&&300>b)return void this.logAndScroll(LOG.SUCCESS,"Done fetching MyAnimeList manga.");this.logAndScroll(LOG.INFO,"Fetching MyAnimeList manga from "+b+" to "+(b+300));try{let d=await fetch("https://myanimelist.net/mangalist/"+a+"/load.json?offset="+b+"&status=7",{method:"GET",redirect:"follow",credentials:"include"}),e=await d.json();if(e.hasOwnProperty("errors"))this.logAndScroll(LOG.DANGER,e.errors[0].message);else{for(let a of e)this.myAnimeListMangaList[parseInt(a.manga_id)]=parseInt(a.num_read_chapters);c||(300==e.length?await this.listMyAnimeList(a,b+300):this.logAndScroll(LOG.SUCCESS,"Done fetching MyAnimeList manga."))}}catch(a){this.flashBackground(!1),console.error(a)}}async listMangaDex(a=1,b=1){this.logAndScroll(LOG.INFO,"Fetching MangaDex follow page manga "+a+(1<b?" of "+b:""));try{let c,d=await fetch("https://mangadex.org/follows/manga/0/0/"+a+"/",{method:"GET",redirect:"follow",credentials:"include"}),e=await d.text(),f=/href="\/title\/(\d+)\/.+"(?:\s*class)/g;for(;null!==(c=f.exec(e));)c.index===f.lastIndex&&f.lastIndex++,this.mangaDexMangaList.push(parseInt(c[1]));if(1==a){let a=/Showing\s\d+\sto\s\d+\sof\s(\d+)\stitles/.exec(e);null!==a&&(b=Math.ceil(a[1]/100))}a<b?await this.listMangaDex(a+1,b):this.logAndScroll(LOG.SUCCESS,"Done fetching MangaDex follow manga.")}catch(a){this.flashBackground(!1),console.error(a)}}async updateLocalFromMDMAL(a=0){var b=Math.max;this.logAndScroll(LOG.INFO,"Updating "+(a+1)+"/"+this.mangaDexMangaList.length),await new Promise(a=>{setTimeout(()=>{a()},500)});try{let c=await fetch("https://mangadex.org/title/"+this.mangaDexMangaList[a],{method:"GET",cache:"no-cache"}),d=await c.text(),e=/<title>(.+)\s*\(Title\)\s*-\s*MangaDex<\/title>/.exec(d)[1],f=/<a.+href='(.+)'>MyAnimeList<\/a>/.exec(d),g={name:e,mangaDexId:this.mangaDexMangaList[a],myAnimeListId:0,lastMangaDexChapter:0,currentChapter:{volume:0,chapter:0},chapters:[]};if(null===f){if(this.logAndScroll(LOG.WARNING,"> "+e+" set to Chapter 0 (No MyAnimeList entry)"),await updateLocalStorage(g,this.options),a++,a<this.mangaDexMangaList.length)return this.updateLocalFromMDMAL(a);this.logAndScroll(LOG.SUCCESS,"Done.")}else{if(f=f[1],g.mal=parseInt(/.+\/(\d+)/.exec(f)[1]),g.mal in this.myAnimeListMangaList&&(g.currentChapter.chapter=this.myAnimeListMangaList[g.mal],this.options.saveAllOpened)){let a=b(g.currentChapter.chapter-this.options.maxChapterSaved,0);for(let b=g.currentChapter.chapter;b>a;b--)g.chapters.push(b)}if(this.logAndScroll(LOG.SUCCESS,"> "+e+" set to Chapter "+g.currentChapter.chapter),await updateLocalStorage(g,this.options),a++,a<this.mangaDexMangaList.length)return this.updateLocalFromMDMAL(a);this.logAndScroll(LOG.SUCCESS,"Done.")}}catch(b){this.flashBackground(!1),this.logAndScroll(LOG.DANGER,"Updating "+(a+1)+" Failed"),console.error(b),a++,a<this.mangaDexMangaList.length?await this.updateLocalFromMDMAL(a):this.logAndScroll(LOG.SUCCESS,"Done.")}}}document.addEventListener("DOMContentLoaded",async()=>{new OptionsManager});