/**
 * Author: Glagan
 * See <https://github.com/Glagan/MyMangaDex> for more informations
 */
let default_options={colors:{last_read:"rgba(95, 158, 160, 0.6)",lower_chapter:"darkolivegreen",last_open:["rgba(102, 51, 153, 0.6)","rgba(75, 0, 130, 0.6)"],opened_chapters:"darkslategray"},hide_lower:!0,last_only_higher:!0,save_all_opened:!0,max_save_opened:100,auto_md_list:!1,version:1.7},MMD_options={},URL=window.location.href,logged_in_mal=!0,csrf_token="";function load_options(){return storage_get("options").then(e=>{if(void 0===e)return MMD_options=default_options,vNotify.info({title:"First time using MyMangaDex",text:"It looks like it is your first time using MyMangaDex, for any help go to https://github.com/Glagan/MyMangaDex, and don't forget to look at the settings !",sticky:!0}),storage_set("options",MMD_options);MMD_options=e;return MMD_options.version<default_options.version?(1.7>MMD_options.version&&(MMD_options.version=1.7,MMD_options.auto_md_list=default_options.auto_md_list,vNotify.info({title:"MyMangaDex as been updated",text:"You can see the changelog on https://github.com/Glagan/MyMangaDex"})),storage_set("options",MMD_options)):Promise.all([])})}function insert_mal_link_form(e,t){var a=document.querySelector(".col-xl-9.col-lg-8.col-md-7"),n=document.createElement("div");n.className="row m-0 py-1 px-0 border-top",n.id="add_mal_link_row";var o=document.createElement("div");o.className="col-lg-3 col-xl-2 strong",o.textContent="MAL link:";var r=document.createElement("div");r.className="col-lg-9 col-xl-10";var l=document.createElement("input");l.id="mymangadex-mal-link-input",l.className="form-control",l.style.display="inline-block",l.style.width="auto",l.style.verticalAlign="middle",l.type="text",l.size=40,l.placeholder="An url like https://myanimelist.net/manga/103939 or an id";var d=document.createElement("button");d.className="btn btn-default",d.type="submit",d.textContent="Send",d.addEventListener("click",()=>{if(""!=l.value){let m=/https:\/\/(?:www\.)?myanimelist\.net\/manga\/(\d+)(?:\/.+)?|(\d+)/.exec(l.value);null==m?vNotify.error({title:"Wrong input",text:"You can only an url like https://myanimelist.net/manga/2, https://myanimelist.net/manga/2/Berserk, or an id"}):(e.mal=parseInt(m[1])||parseInt(m[2]),0<e.mal?fetch_mal_for_manga_data(e).then(()=>{return e.more_info.exist?update_manga_local_storage(e,!1).then(()=>{insert_mal_informations(r,e),highlight_chapters(e,t),vNotify.success({title:"MyAnimeList id set",text:"Nice.",image:"https://i.imgur.com/oMV2BJt.png"})}):void vNotify.error({title:"The manga doesn't exist.",text:"Check the id maybe ?"})}):vNotify.error({title:"Wrong input",text:"id need to be > 0"}))}}),r.appendChild(l),r.appendChild(document.createTextNode(" ")),r.appendChild(d),n.appendChild(o),n.appendChild(r),a.insertBefore(n,a.lastElementChild)}function update_md_list(e,t,a){let n=new Date().getTime();return fetch("https://mangadex.org/ajax/actions.ajax.php?function="+t+"&id="+e+"&type="+a+"&_="+n,{method:"GET",redirect:"follow",credentials:"include",headers:{"X-Requested-With":"XMLHttpRequest"}}).then(()=>{vNotify.info({title:"Status on MangaDex updated"})}).catch(()=>{vNotify.error({title:"Error updating MDList"})})}function fetch_mal_for_manga_data(e){return fetch("https://myanimelist.net/ownlist/manga/"+e.mal+"/edit?hideLayout",{method:"GET",redirect:"follow",cache:"no-cache",credentials:"include"}).then(t=>{return e.more_info={},e.more_info.redirected=t.redirected,t.text().then(a=>{"401 Unauthorized"==a?(vNotify.error({title:"Not logged in",text:"Log in on MyAnimeList!",image:"https://i.imgur.com/oMV2BJt.png"}),logged_in_mal=!1):(csrf_token=/'csrf_token'\scontent='(.{40})'/.exec(a)[1],e.more_info.is_approved=!/class="badresult"/.test(a),e.more_info.exist=!/id="queryTitle"/.test(a),e.more_info.comments=/add_manga_comments.+>(.*)</.exec(a)[1],e.more_info.finish_date={},e.more_info.finish_date.month=parseInt(/add_manga_finish_date_month.+\s.+value="(\d+)?"\s*selected="selected"/.exec(a)[1])||"",e.more_info.finish_date.day=parseInt(/add_manga_finish_date_day.+\s.+value="(\d+)?"\s*selected="selected"/.exec(a)[1])||"",e.more_info.finish_date.year=parseInt(/add_manga_finish_date_year.+\s.+value="(\d+)?"\s*selected="selected"/.exec(a)[1])||"",e.more_info.ask_to_discuss=/add_manga_is_asked_to_discuss.+\s.+value="(\d+)?"\s*selected="selected"/.exec(a),e.more_info.ask_to_discuss=null===e.more_info.ask_to_discuss?0:parseInt(e.more_info.ask_to_discuss[1]),e.last_mal=/add_manga_num_read_chapters.+value="(\d+)?"/.exec(a),e.last_mal=null===e.last_mal?0:parseInt(e.last_mal[1]),e.more_info.total_reread=/add_manga_num_read_times.+value="(\d+)?"/.exec(a),e.more_info.total_reread=null===e.more_info.total_reread?0:parseInt(e.more_info.total_reread[1]),e.more_info.last_volume=/add_manga_num_read_volumes.+value="(\d+)?"/.exec(a),e.more_info.last_volume=null===e.more_info.last_volume?0:parseInt(e.more_info.last_volume[1]),e.more_info.retail_volumes=/add_manga_num_retail_volumes.+value="(\d+)?"/.exec(a),e.more_info.retail_volumes=null===e.more_info.retail_volumes?0:parseInt(e.more_info.retail_volumes[1]),e.more_info.priority=/add_manga_priority.+\s.+value="(\d+)?"\s*selected="selected"/.exec(a),e.more_info.priority=null===e.more_info.priority?0:parseInt(e.more_info.priority[1]),e.more_info.reread_value=/add_manga_reread_value.+\s.+value="(\d+)?"\s*selected="selected"/.exec(a),e.more_info.reread_value=null===e.more_info.reread_value?"":e.more_info.reread_value[1],e.more_info.score=/add_manga_score.+\s.+value="(\d+)?"\s*selected="selected"/.exec(a),e.more_info.score=null===e.more_info.score?"":parseInt(e.more_info.score[1]),e.more_info.sns_post_type=/add_manga_sns_post_type.+\s.+value="(\d+)?"\s*selected="selected"/.exec(a),e.more_info.sns_post_type=null===e.more_info.sns_post_type?0:parseInt(e.more_info.sns_post_type[1]),e.more_info.start_date={},e.more_info.start_date.month=parseInt(/add_manga_start_date_month.+\s.+value="(\d+)?"\s*selected="selected"/.exec(a)[1])||"",e.more_info.start_date.day=parseInt(/add_manga_start_date_day.+\s.+value="(\d+)?"\s*selected="selected"/.exec(a)[1])||"",e.more_info.start_date.year=parseInt(/add_manga_start_date_year.+\s.+value="(\d+)?"\s*selected="selected"/.exec(a)[1])||"",e.more_info.status=/add_manga_status.+\s.+value="(\d+)?"\s*selected="selected"/.exec(a),e.more_info.status=null===e.more_info.status?0:parseInt(e.more_info.status[1]),e.more_info.storage_type=/add_manga_storage_type.+\s.+value="(\d+)?"\s*selected="selected"/.exec(a),e.more_info.storage_type=null===e.more_info.storage_type?"":e.more_info.storage_type[1],e.more_info.tags=/add_manga_tags.+>(.*)*</.exec(a)[1]||"",e.more_info.is_rereading=/name="add_manga\[is_rereading\]"\s*value="\d*"\s*checked="checked"/.test(a),e.more_info.total_volume=parseInt(/id="totalVol">(.*)?<\//.exec(a)[1])||0,e.more_info.total_chapter=parseInt(/id="totalChap">(.*)?<\//.exec(a)[1])||0)})}).catch(console.error)}function update_manga_last_read(e,t=!0,a=1){if(logged_in_mal){if(e.more_info.is_approved){let o="https://myanimelist.net/ownlist/manga/"+e.mal+"/edit?hideLayout",r=parseInt(e.more_info.status);if(t){if(0==e.last_mal||Math.floor(e.current.chapter)>e.last_mal){if(r=2==parseInt(e.more_info.status)||0<parseInt(e.more_info.total_chapter)&&e.current.chapter>=parseInt(e.more_info.total_chapter)?2:a,e.more_info.started=!1,6!=r&&(6==e.more_info.status||0==e.more_info.status)&&""==e.more_info.start_date.year){e.more_info.started=!0;let l=new Date;e.more_info.start_date.year=l.getFullYear(),e.more_info.start_date.month=l.getMonth()+1,e.more_info.start_date.day=l.getDate()}if(0==e.more_info.status&&(o="https://myanimelist.net/ownlist/manga/add?selected_manga_id="+e.mal_id+"&hideLayout"),2==r&&""==e.more_info.finish_date.year){let l=new Date;e.more_info.finish_date.year=l.getFullYear(),e.more_info.finish_date.month=l.getMonth()+1,e.more_info.finish_date.day=l.getDate()}e.last_mal=e.current.chapter,e.last_volume=e.current.volume,e.more_info.status=r}else return void vNotify.info({title:"Not updated",text:"Last read chapter on MyAnimelist is higher or equal to the current chapter, it wasn't updated.",image:"https://mangadex.org/images/manga/"+e.id+".thumb.jpg"});e.more_info.is_rereading&&0<parseInt(e.more_info.total_chapter)&&e.current.chapter>=parseInt(e.more_info.total_chapter)&&(e.more_info.is_rereading=!1,e.more_info.total_reread++)}var n="";return n+=encodeURIComponent("add_manga[comments]")+"="+encodeURIComponent(e.more_info.comments)+"&",n+=encodeURIComponent("add_manga[finish_date][day]")+"="+e.more_info.finish_date.day+"&",n+=encodeURIComponent("add_manga[finish_date][month]")+"="+e.more_info.finish_date.month+"&",n+=encodeURIComponent("add_manga[finish_date][year]")+"="+e.more_info.finish_date.year+"&",n+=encodeURIComponent("add_manga[is_asked_to_discuss]")+"="+e.more_info.ask_to_discuss+"&",n+=encodeURIComponent("add_manga[num_read_chapters]")+"="+Math.floor(e.current.chapter)+"&",n+=encodeURIComponent("add_manga[num_read_times]")+"="+e.more_info.total_reread+"&",n+=encodeURIComponent("add_manga[num_read_volumes]")+"="+e.current.volume+"&",n+=encodeURIComponent("add_manga[num_retail_volumes]")+"="+e.more_info.retail_volumes+"&",n+=encodeURIComponent("add_manga[priority]")+"="+e.more_info.priority+"&",n+=encodeURIComponent("add_manga[reread_value]")+"="+e.more_info.reread_value+"&",n+=encodeURIComponent("add_manga[score]")+"="+e.more_info.score+"&",n+=encodeURIComponent("add_manga[sns_post_type]")+"="+e.more_info.sns_post_type+"&",n+=encodeURIComponent("add_manga[start_date][day]")+"="+e.more_info.start_date.day+"&",n+=encodeURIComponent("add_manga[start_date][month]")+"="+e.more_info.start_date.month+"&",n+=encodeURIComponent("add_manga[start_date][year]")+"="+e.more_info.start_date.year+"&",n+=encodeURIComponent("add_manga[status]")+"="+r+"&",n+=encodeURIComponent("add_manga[storage_type]")+"="+e.more_info.storage_type+"&",n+=encodeURIComponent("add_manga[tags]")+"="+encodeURIComponent(e.more_info.tags)+"&",e.more_info.is_rereading&&(n+=encodeURIComponent("add_manga[is_rereading]")+"=1&"),n+=encodeURIComponent("csrf_token")+"="+csrf_token+"&",n+="last_completed_vol=&",n+="manga_id="+e.mal+"&",n+="submitIt=0",fetch(o,{method:"POST",body:n,redirect:"follow",credentials:"include",headers:{"Content-Type":"application/x-www-form-urlencoded",accept:"text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8"}}).then(()=>{t&&(6==r?vNotify.success({title:"Added to Plan to Read",text:e.name+" as been put in your endless Plan to read list !",image:"https://mangadex.org/images/manga/"+e.id+".thumb.jpg"}):(0<e.last_mal&&vNotify.success({title:"Manga updated",text:e.name+" as been updated to chapter "+e.current.chapter+(0<parseInt(e.more_info.total_chapter)?" out of "+e.more_info.total_chapter:""),image:"https://mangadex.org/images/manga/"+e.id+".thumb.jpg"}),e.more_info.started&&(vNotify.success({title:"Manga updated",text:"You started reading "+e.name,image:"https://mangadex.org/images/manga/"+e.id+".thumb.jpg"}),MMD_options.auto_md_list&&update_md_list(e.id,"manga_follow",1)),6!=r&&(0==e.more_info.status||6==e.more_info.status)&&vNotify.success({title:"Started manga",text:"The start date of "+e.name+" was set to today.",image:"https://mangadex.org/images/manga/"+e.id+".thumb.jpg"}),2==r&&!e.more_info.is_rereading&&(vNotify.success({title:"Manga completed",text:e.name+" was set as completed.",image:"https://mangadex.org/images/manga/"+e.id+".thumb.jpg"}),MMD_options.auto_md_list&&update_md_list(e.id,"manga_follow",2))))}).catch(console.error)}vNotify.info({title:"Not updated",text:"The manga is still pending approval on MyAnimelist and can't be updated.",image:"https://i.imgur.com/oMV2BJt.png"})}return!1}function update_manga_local_storage(e,t=!0){return e.last=e.current.chapter>e.last&&MMD_options.last_only_higher||!MMD_options.last_only_higher?e.current.chapter:e.last,storage_set(e.id,{mal:e.mal,last:e.last,chapters:e.chapters}).then(()=>{t&&0==e.mal&&(e.current.chapter>e.last&&MMD_options.last_only_higher||!MMD_options.last_only_higher)&&vNotify.success({title:"Manga updated",text:e.name+" last open Chapter as been updated to "+(e.current.chapter>e.last&&MMD_options.last_only_higher||!MMD_options.last_only_higher?e.current.chapter:e.last),image:"https://mangadex.org/images/manga/"+e.id+".thumb.jpg"})})}function add_simple_input(e,t,a,n="",o=[]){let r=document.createElement(a);switch(a){case"text":r=document.createElement("input"),r.type="text";case"textarea":r.value=n;break;case"select":r.style.display="inline-block",r.style.width="auto";for(let l of o){let d=document.createElement("option");d.value=l.value,d.textContent=l.content||l.value,l.value==n&&(d.selected="selected"),r.appendChild(d)}}return r.className="form-control",e.appendChild(document.createTextNode(t)),e.appendChild(r),e.appendChild(document.createTextNode(" ")),r}function add_row(e,t,a="",n="",o=[],r=""){let l=document.createElement("tr"),d=document.createElement("td");d.textContent=t,l.appendChild(d);let m,s=document.createElement("td");if(""!=a){switch(m=document.createElement(a),a){case"text":m=document.createElement("input"),m.type="text",""!=r&&m.classList.add("mmd-half");case"textarea":m.value=n;break;case"a":m.textContent=n,m.href="https://myanimelist.net/manga/"+o,m.target="blank";break;case"select":for(let c of o){let u=document.createElement("option");u.value=c.value,u.textContent=c.content||c.value,c.value==n&&(u.selected="selected"),m.appendChild(u)}}m.classList.add("form-control"),s.appendChild(m),""!=r&&s.appendChild(document.createTextNode(r))}return l.appendChild(s),e.appendChild(l),""==a?s:m}function insert_mal_button(e,t,a){var n=document.createElement("a");n.title="Edit on MyAnimeList",a?(n.className="btn btn-secondary float-right mr-1",append_text_with_icon(n,"edit","Edit on MyAnimeList")):(n.className="btn btn-secondary col m-1",append_text_with_icon(n,"edit","")),n.addEventListener("click",()=>{let r=document.getElementById("mmd-modal-container");if(r)r.style.display="block",r.firstElementChild.classList.add("mmd-opening"),setTimeout(()=>{r.firstElementChild.classList.remove("mmd-opening")},500);else{let l=document.createElement("div");l.id="mmd-modal-container",l.className="mmd-fadein";let d=document.createElement("div");d.id="mmd-modal",d.className="mmd-opening";let s=document.createElement("span");s.className="mmd-close-button",s.textContent="\xD7",s.addEventListener("click",N=>{N.preventDefault(),l.style.display="none"});let m=document.createElement("h1");m.textContent="Edit informations";let c=document.createElement("table");c.className="mmd-content";let u=document.createElement("tbody"),_={start_date:{},finish_date:{}},p=document.createElement("a");p.className="btn btn-success mmd-save";let h=document.createElement("span");h.className="fas fa-save",p.appendChild(h),p.appendChild(document.createTextNode(" Save")),p.addEventListener("click",N=>{for(let L in N.target.disabled=!0,_)t.more_info[L]="start_date"==L||"finish_date"==L?{month:_[L].month.value,day:_[L].day.value,year:_[L].year.value}:_[L].value;t.more_info.is_rereading=_.is_rereading.checked,t.current.volume=parseInt(_.last_volume.value),t.current.chapter=parseInt(_.last_mal.value),t.last_mal=parseInt(_.last_mal.value),update_manga_last_read(t,!1).then(()=>{a&&(clear_dom_node(e),insert_mal_informations(e,t)),l.style.display="none",vNotify.success({title:"Manga Updated",image:"https://i.imgur.com/oMV2BJt.png"})})}),c.appendChild(p);let f=[{value:"",content:""},{value:1,content:"Jan"},{value:2,content:"Feb"},{value:3,content:"Mar"},{value:4,content:"Apr"},{value:5,content:"May"},{value:6,content:"June"},{value:7,content:"Jul"},{value:8,content:"Aug"},{value:9,content:"Sep"},{value:10,content:"Oct"},{value:11,content:"Nov"},{value:12,content:"Dec"}],g=[{value:""},{value:1},{value:2},{value:3},{value:4},{value:5},{value:6},{value:7},{value:8},{value:9},{value:10},{value:11},{value:12},{value:13},{value:14},{value:15},{value:16},{value:17},{value:18},{value:19},{value:20},{value:21},{value:22},{value:23},{value:24},{value:25},{value:26},{value:27},{value:28},{value:29},{value:30},{value:31}],v=[{value:""},{value:2018},{value:2017},{value:2016},{value:2015},{value:2014},{value:2013},{value:2012},{value:2011},{value:2010},{value:2009},{value:2008},{value:2007},{value:2006},{value:2005},{value:2004},{value:2003},{value:2002},{value:2001},{value:2e3},{value:1999},{value:1998},{value:1997},{value:1996},{value:1995},{value:1994},{value:1993},{value:1992},{value:1991},{value:1990},{value:1989},{value:1988}];add_row(u,"Title","a",t.name,t.mal,"Click to open in a new tab"),_.status=add_row(u,"Status","select",t.more_info.status,[{value:1,content:"Reading"},{value:2,content:"Completed"},{value:3,content:"On-Hold"},{value:4,content:"Dropped"},{value:6,content:"Plan to Read"}]),_.last_volume=add_row(u,"Volumes Read","text",t.more_info.last_volume,{}," / "+t.more_info.total_volume),_.last_mal=add_row(u,"Chapters Read","text",t.last_mal,{}," / "+t.more_info.total_chapter);let y=document.createElement("tr"),x=document.createElement("td"),C=document.createElement("label");C.setAttribute("for","mmd_rereading"),C.textContent="Re-reading",x.appendChild(C),y.appendChild(x);let E=document.createElement("td");_.is_rereading=document.createElement("input"),_.is_rereading.type="checkbox",_.is_rereading.id="mmd_rereading",t.more_info.is_rereading&&(_.is_rereading.checked=!0),E.appendChild(_.is_rereading),y.appendChild(E),u.appendChild(y),_.score=add_row(u,"Your Score","select",t.more_info.score,[{value:"",content:"Select score"},{value:10,content:"(10) Masterpiece"},{value:9,content:"(9) Great"},{value:8,content:"(8) Very Good"},{value:7,content:"(7) Good"},{value:6,content:"(6) Fine"},{value:5,content:"(5) Average"},{value:4,content:"(4) Bad"},{value:3,content:"(3) Very Bad"},{value:2,content:"(2) Horrible"},{value:1,content:"(1) Appalling"}]);let b=add_row(u,"Start Date");_.start_date.month=add_simple_input(b,"Month: ","select",t.more_info.start_date.month,f),_.start_date.day=add_simple_input(b,"Day: ","select",t.more_info.start_date.day,g),_.start_date.year=add_simple_input(b,"Year: ","select",t.more_info.start_date.year,v);let k=document.createElement("a");k.textContent="Insert Today",k.addEventListener("click",()=>{let L=new Date;_.start_date.month.value=L.getMonth()+1,_.start_date.day.value=L.getDate(),_.start_date.year.value=L.getFullYear()}),b.appendChild(k);let w=add_row(u,"Finish Date");_.finish_date.month=add_simple_input(w,"Month: ","select",t.more_info.finish_date.month,f),_.finish_date.day=add_simple_input(w,"Day: ","select",t.more_info.finish_date.day,g),_.finish_date.year=add_simple_input(w,"Year: ","select",t.more_info.finish_date.year,v);let M=document.createElement("a");M.textContent="Insert Today",M.addEventListener("click",()=>{let L=new Date;_.finish_date.month.value=L.getMonth()+1,_.finish_date.day.value=L.getDate(),_.finish_date.year.value=L.getFullYear()}),w.appendChild(M),_.tags=add_row(u,"Tags","textarea",t.more_info.tags),_.priority=add_row(u,"Priority","select",t.more_info.priority,[{value:0,content:"Low"},{value:1,content:"Medium"},{value:2,content:"High"}]),_.storage=add_row(u,"Storage","select",t.more_info.storage,[{value:"",content:"None"},{value:1,content:"Hard Drive"},{value:6,content:"External HD"},{value:7,content:"NAS"},{value:8,content:"Blu-ray"},{value:2,content:"DVD / CD"},{value:4,content:"Retail Manga"},{value:5,content:"Magazine"}]),_.retail_volumes=add_row(u,"How many volumes?","text",t.more_info.retail_volumes),_.total_reread=add_row(u,"Total Times Re-read","text",t.more_info.total_reread),_.reread_value=add_row(u,"Re-read Value","select",t.more_info.reread_value,[{value:"",content:"Select reread value"},{value:1,content:"Very Low"},{value:2,content:"Low"},{value:3,content:"Medium"},{value:4,content:"High"},{value:5,content:"Very High"}]),_.comments=add_row(u,"Comments","textarea",t.more_info.comments),_.ask_to_discuss=add_row(u,"Ask to Discuss?","select",t.more_info.ask_to_discuss,[{value:0,content:"Ask to discuss a chapter after you update the chapter #"},{value:1,content:"Don't ask to discuss"}]),_.sns_post_type=add_row(u,"Post to SNS","select",t.more_info.sns_post_type,[{value:0,content:"Follow default setting"},{value:1,content:"Post with confirmation"},{value:2,content:"Post every time (without confirmation)"},{value:3,content:"Do not post"}]),d.appendChild(s),d.appendChild(m),c.appendChild(u),d.appendChild(c),l.appendChild(d),document.body.appendChild(l),setTimeout(()=>{d.classList.remove("mmd-opening")},500)}}),e.appendChild(n)}function insert_reread_button(e,t){var a=document.createElement("a");a.title="Re-read",a.className="btn btn-secondary float-right mr-1",append_text_with_icon(a,"book-open","Re-read"),a.addEventListener("click",()=>{t.current.chapter=0,t.last_mal=0,t.current.volume=0,t.more_info.last_volume=0,t.more_info.is_rereading=1,update_manga_last_read(t,!1).then(()=>{clear_dom_node(e),insert_mal_informations(e,t),vNotify.success({title:"Re-reading",text:"You started re-reading "+t.name,image:"https://mangadex.org/images/manga/"+t.id+".thumb.jpg"})})}),e.appendChild(a)}function append_status(e,t){let o=[{color:"blueviolet",text:"Not on the list"},{color:"cornflowerblue",text:"Reading"},{color:"darkseagreen",text:"Completed"},{color:"orange",text:"On-Hold"},{color:"firebrick",text:"Dropped"},null,{color:"violet",text:"Plan to Read"}],r=document.createElement("span");r.style.color=o[e].color,r.textContent=o[e].text,t.appendChild(r)}function clear_dom_node(e){for(;e.firstChild;)e.removeChild(e.firstChild)}function insert_mal_informations(e,t){clear_dom_node(e),insert_mal_button(e,t,!0),2!=t.more_info.status||t.more_info.is_rereading||insert_reread_button(e,t),append_status(t.more_info.status,e),e.appendChild(document.createElement("br")),append_text_with_icon(e,"book","Volume "+t.more_info.last_volume+(0<parseInt(t.more_info.total_volume)?" out of "+t.more_info.total_volume:"")),e.appendChild(document.createElement("br")),append_text_with_icon(e,"bookmark","Chapter "+t.last_mal+(0<parseInt(t.more_info.total_chapter)?" out of "+t.more_info.total_chapter:"")+(t.more_info.is_rereading?" - Re-reading":"")),e.appendChild(document.createElement("br")),""!=t.more_info.start_date.year&&(append_text_with_icon(e,"calendar-alt","Start date "+t.more_info.start_date.year+"/"+t.more_info.start_date.month+"/"+t.more_info.start_date.day),e.appendChild(document.createElement("br"))),2==t.more_info.status&&""!=t.more_info.finish_date.year&&(append_text_with_icon(e,"calendar-alt","Finish date "+t.more_info.finish_date.year+"/"+t.more_info.finish_date.month+"/"+t.more_info.finish_date.day),e.appendChild(document.createElement("br")));let a;a=""==t.more_info.score?"Not scored yet":"Scored "+t.more_info.score+" out of 10",append_text_with_icon(e,"star",a)}function highlight_chapters(e,t){for(let a of t)if(e.last_mal==parseInt(a.chapter))a.node.style.backgroundColor=MMD_options.colors.last_read;else if(e.last==a.chapter)a.node.style.backgroundColor=MMD_options.colors.last_open[0];else if(MMD_options.save_all_opened)for(let n of e.chapters)if(a.chapter==n){a.node.style.backgroundColor=MMD_options.colors.opened_chapters;break}}function add_to_mal_list(e,t,a){a.textContent="Loading...",fetch_mal_for_manga_data(e).then(update_manga_last_read(e,!0,t)).then(insert_mal_informations(a,e))}function volume_and_chapter_from_node(e){let t=e.getAttribute("data-chapter");return""==t?volume_and_chapter_from_string(e.children[1].textContent):{volume:parseInt(e.getAttribute("data-volume"))||0,chapter:parseFloat(t)||1}}function volume_and_chapter_from_string(e){let t=/(?:Vol(?:[.]|ume)\s([0-9]+)\s)?(?:Ch(?:[.]|apter)\s)?([0-9]+)([.][0-9]+)?/.exec(e);return null==t&&(t=[0,0,1,void 0]),{volume:parseInt(t[1])||0,chapter:parseFloat(t[2]+""+t[3])}}function append_text_with_icon(e,t,a){let n=document.createElement("span");n.className="fas fa-"+t+" fa-fw",n.setAttribute("aria-hidden",!0),e.appendChild(n),e.appendChild(document.createTextNode(" "+a))}function tooltip(e,t,a,n=void 0){e.addEventListener("mouseenter",o=>{o.preventDefault();let r=document.getElementById("tooltip-"+t);if(null===r){let l=document.createElement("div");l.className="mmd-tooltip mmd-active",l.id="tooltip-"+t;let d=document.createElement("img");d.src="https://mangadex.org/images/manga/"+a+".thumb.jpg";let s=o.target.getBoundingClientRect(),m=window.scrollY;if(l.style.width="100px",l.style.left=s.x-105+"px",l.style.top=s.y+s.height/2+m-143/2+"px",d.addEventListener("load",()=>{let c=d.getBoundingClientRect();l.style.left=s.x-c.width-5+"px",l.style.top=s.y+s.height/2+m-c.height/2+"px",l.style.maxWidth=c.width+2+"px"}),l.appendChild(d),MMD_options.save_all_opened&&void 0!==n&&void 0!==n.chapters&&0<n.chapters.length){d.className="mmd-tooltip-image";let c=document.createElement("div");c.className="mmd-tooltip-content";let u=Math.min(5,n.chapters.length);for(let _=0;_<u;_++)append_text_with_icon(c,"eye",n.chapters[_]),c.appendChild(document.createElement("br"));l.appendChild(c)}document.getElementById("mmd-tooltip").appendChild(l)}else r.classList.add("mmd-active")}),e.addEventListener("mouseleave",o=>{o.preventDefault();let r=document.getElementById("tooltip-"+t);null!==r&&r.classList.remove("mmd-active")})}function start(){-1<URL.indexOf("org/follows")||-1<URL.indexOf("org/group")&&(-1<URL.indexOf("/chapters/")||-1==URL.indexOf("/manga/")&&-1==URL.indexOf("/comments/"))||-1<URL.indexOf("org/user")&&(-1<URL.indexOf("/chapters/")||-1==URL.indexOf("/manga/"))?follow_page(!(-1<URL.indexOf("org/group")||-1<URL.indexOf("org/user"))):-1<URL.indexOf("org/title")||-1<URL.indexOf("org/manga")?manga_page():-1<URL.indexOf("org/chapter")?chapter_page():(-1<URL.indexOf("org/search")||-1<URL.indexOf("org/?page=search")||-1<URL.indexOf("org/?page=titles")||-1<URL.indexOf("org/featured")||-1<URL.indexOf("org/titles")||-1<URL.indexOf("org/list")||-1<URL.indexOf("org/group")&&-1<URL.indexOf("/manga/")||-1<URL.indexOf("org/user")&&-1<URL.indexOf("/manga/"))&&search_and_list_page()}function follow_page(){let t=document.querySelector(".chapter-container").children;var a={},n=MMD_options.colors.last_open.length,o=0;let r=document.createElement("div");r.id="mmd-tooltip",document.body.appendChild(r);let l={},d=t.length-1;for(let s=d;0<s;--s){let m=t[s],c=volume_and_chapter_from_node(m.lastElementChild.firstElementChild);if(0<m.firstElementChild.childElementCount){let u=parseInt(/\/title\/(\d+)\//.exec(m.firstElementChild.firstElementChild.href)[1]),_={};is_empty(a)||(a.dom_nodes.push(m),a.chapters.push(c),_={dom_nodes:a.dom_nodes,chapters:a.chapters}),a={};let p=l[u];l[u]===void 0&&(l[u]=storage_get(u),p=l[u]),p.then(h=>{let f=!0;if(h!==void 0){let g=MMD_options.colors.last_open[o];if(is_empty(_))c.chapter==h.last?(m.style.backgroundColor=g,o=(o+1)%n):c.chapter<h.last?(f=!1,MMD_options.hide_lower?m.parentElement.removeChild(m):m.style.backgroundColor=MMD_options.colors.lower_chapter):(m.children[2].firstElementChild.addEventListener("auxclick",()=>{m.style.backgroundColor=g}),o=(o+1)%n);else{let v=!1,y=!1,x=_.chapters.length-1;for(let C in _.chapters){let E=_.chapters[C].chapter,b=_.dom_nodes[C],k=!0;E<h.last&&(parseInt(C)<x||parseInt(C)==x&&!v&&!y)?(k=!1,parseInt(C)==x&&(f=!1),MMD_options.hide_lower?b.parentElement.removeChild(b):b.style.backgroundColor=MMD_options.colors.lower_chapter):E==h.last?(v=!0,b.style.backgroundColor=g,o=(o+1)%n):(y=!0,v&&(b.firstElementChild.style.backgroundColor=g),b.children[2].firstElementChild.addEventListener("auxclick",()=>{b.style.backgroundColor=g}))}}}f&&tooltip(m,s,u,h)})}else is_empty(a)?a={dom_nodes:[m],chapters:[c]}:(a.dom_nodes.push(m),a.chapters.push(c))}}function manga_page(){let e={name:document.querySelector("h6[class='card-header']").textContent.trim(),id:parseInt(/.+title\/(\d+)/.exec(URL)[1]),mal:0,last:0,current:{volume:0,chapter:0},chapters:[]},t=[];var a=document.querySelector(".chapter-container").children;let n=a.length;for(let l,r=1;r<n;r++){l=a[r];var o=volume_and_chapter_from_node(l.firstElementChild.firstElementChild);t.push({node:l,chapter:o.chapter,volume:o.volume})}storage_get(e.id).then(r=>{let l=!1,d=document.querySelector("img[src='/images/misc/mal.png'");r===void 0?(l=!0,e.last=0,null===d?vNotify.error({title:"No MyAnimeList id found",text:"You can add one using the form.\nLast open chapter will still be saved.",sticky:!0}):(d=d.nextElementSibling.href,e.mal=parseInt(/.+\/(\d+)/.exec(d)[1])),update_manga_local_storage(e,!1)):(e.mal=r.mal,0==e.mal&&null!==d&&(d=d.nextElementSibling.href,e.mal=parseInt(/.+\/(\d+)/.exec(d)[1]),l=!0),e.last=r.last,e.chapters=r.chapters||[]),0<e.mal?fetch_mal_for_manga_data(e).then(()=>{if(logged_in_mal){var m=document.querySelector(".col-xl-9.col-lg-8.col-md-7"),c=document.createElement("div");c.className="row m-0 py-1 px-0 border-top";var u=document.createElement("div");u.className="col-lg-3 col-xl-2 strong",u.textContent="Status:";var _=document.createElement("div");if(_.className="col-lg-9 col-xl-10",!e.more_info.is_approved){let f=document.createElement("span");f.style.color="firebrick",f.textContent="The manga is still pending approval on MyAnimelist and can't be updated",_.appendChild(f)}else if(!1==e.more_info.redirected)insert_mal_informations(_,e),l&&(e.last=Math.max(e.last_mal,e.last),insert_chapter(e.chapters,e.last),update_manga_local_storage(e,!1));else{var p=document.createElement("button");p.className="btn btn-default",p.textContent="Start Reading",p.addEventListener("click",()=>{add_to_mal_list(e,1,_)});var h=document.createElement("button");h.className="btn btn-default",h.textContent="Add to Plan to Read list",h.addEventListener("click",()=>{add_to_mal_list(e,6,_)}),_.appendChild(p),_.appendChild(document.createTextNode(" ")),_.appendChild(h)}highlight_chapters(e,t),c.appendChild(u),c.appendChild(_),m.insertBefore(c,m.lastElementChild)}}):(insert_mal_link_form(e,t),highlight_chapters(e,t))},r=>{console.error("Error fetching data from local storage.",r)})}function chapter_page(){let e={name:"",id:0,chapter_id:0,mal:0,last:0,current:0,chapters:[],mal_checked:!1};if(chapter_info=document.querySelector("meta[property='og:title']").content,e.current=volume_and_chapter_from_string(chapter_info),e.name=/.*\((.+)\)/.exec(chapter_info)[1],chapter_info=document.querySelector("meta[property='og:image']").content,e.id=parseInt(/manga\/(\d+)\.thumb.+/.exec(chapter_info)[1]),e.chapter_id=parseInt(document.querySelector("meta[name='app']").dataset.chapterId),0==document.getElementsByClassName("card-header").length){var t=new MutationObserver(o=>{for(var r of o)if("attributes"==r.type){let l=parseInt(document.querySelector(".chapter-title").dataset.chapterId);e.chapter_id!=l&&(e.chapter_id=l,fetch("https://mangadex.org/api/chapter/"+e.chapter_id+"?").then(d=>d.json()).then(d=>{"delayed"===d.status?vNotify.error({title:"Chapter Delayed",text:"The chapter was not updated and saved since it is delayed on MangaDex.",image:"https://mangadex.org/images/manga/"+e.id+".thumb.jpg"}):(e.current.chapter=d.chapter,e.current.volume=parseInt(d.volume)||0,e.mal_checked&&0<e.mal&&update_manga_last_read(e),MMD_options.save_all_opened&&insert_chapter(e.chapters,e.current.chapter),update_manga_local_storage(e))}))}});t.observe(document.querySelector(".chapter-title"),{attributes:!0})}let a=0<document.getElementsByClassName("alert alert-danger text-center m-auto").length;check_manga_for_mal_id(e).then(()=>{0<e.mal&&fetch_mal_for_manga_data(e).then(()=>{e.more_info.exist&&e.more_info.is_approved&&insert_mal_button(document.querySelector(".reader-controls-actions.col-auto.row.no-gutters.p-1").lastElementChild,e,!1)}).then(()=>{a||update_manga_last_read(e)}),a?vNotify.error({title:"Chapter Delayed",text:"The chapter was not updated and saved since it is delayed on MangaDex.",image:"https://mangadex.org/images/manga/"+e.id+".thumb.jpg"}):(MMD_options.save_all_opened&&insert_chapter(e.chapters,e.current.chapter),update_manga_local_storage(e))})}function check_manga_for_mal_id(e){return storage_get(e.id).then(t=>{let a=[];return void 0===t?(vNotify.info({title:"No MyAnimeList id in storage",text:"Fetching MangaDex manga page of "+e.name+" to find a MyAnimeList id."}),a.push(fetch("https://mangadex.org/title/"+e.id,{method:"GET",cache:"no-cache"}).then(n=>n.text()).then(n=>{let o=/<a.+href='(.+)'>MyAnimeList<\/a>/.exec(n);null===o?vNotify.error({title:"No MyAnimeList id found",text:"You can add one using the form.\nLast open chapter is still saved.",sticky:!0}):e.mal=parseInt(/.+\/(\d+)/.exec(o[1])[1])}).catch(n=>console.error(n)))):(e.mal=t.mal,e.last=t.last,e.chapters=t.chapters||[]),Promise.all(a).then(()=>{e.mal_checked=!0})}).catch(t=>{console.error("Error fetching data from local storage.",t)})}function search_and_list_page(){let e=document.querySelectorAll(".row.m-0.border-bottom"),t=e.length;if(0!=t){let a=document.createElement("div");a.id="mmd-tooltip",document.body.appendChild(a);for(let o,n=1;n<t;n++)o=/title\/(\d+)\/?.*/.exec(e[n].firstElementChild.firstElementChild.firstElementChild.children[1].href)[1],tooltip(e[n],n,o)}}load_options().then(start);