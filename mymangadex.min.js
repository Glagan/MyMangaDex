/**
 * Author: Glagan
 * See <https://github.com/Glagan/MyMangaDex> for more informations
 */
let default_options={colors:{last_read:"rgba(95,158,160,0.6)",lower_chapter:"darkolivegreen",last_open:["rgba(102, 51, 153, 0.6)","rgba(75, 0, 130, 0.6)"],opened_chapters:"darkslategray"},hide_lower:!0,last_only_higher:!0,save_all_opened:!0,max_save_opened:100,version:1.5},MMD_options={},URL=window.location.href,logged_in_mal=!0,csrf_token="";function is_empty(e){for(let t in e)return!1;return!0}function storage_get(e){return browser.storage.local.get(null===e?null:e+"").then(t=>{return null===e?t:t[e]}).catch(t=>{console.error(t)})}function storage_set(e,t){return browser.storage.local.set(null===e?t:{[e]:t}).catch(a=>{console.error(a)})}function load_options(){return storage_get("options").then(e=>{if(void 0===e)return MMD_options=default_options,storage_set("options",MMD_options);MMD_options={colors:{last_read:e.colors.last_read||default_options.colors.last_read,lower_chapter:e.colors.lower_chapter||default_options.colors.lower_chapter,last_open:e.colors.last_open||default_options.colors.last_open,opened_chapters:e.colors.opened_chapters||default_options.colors.opened_chapters},hide_lower:e.hide_lower,follow_button:e.follow_button,last_only_higher:e.last_only_higher,max_save_opened:e.max_save_opened||default_options.max_save_opened,save_all_opened:e.save_all_opened,version:e.version||default_options.version};let t=[];return MMD_options.version<default_options.version?(1.3>MMD_options.version&&(console.info("Updating to the 1.3 save format..."),MMD_options.max_save_opened=100,MMD_options.version=1.3,t.push(storage_get(null).then(a=>{for(let n in a)if("options"==n)a.options.version=1.3;else for(;a[n].chapters.length>MMD_options.max_save_opened;)a[n].chapters.pop();return storage_set(null,a).then(()=>{console.info("Done updating to the 1.3 save format.")})}))),1.4>MMD_options.version&&(MMD_options.version=1.4,MMD_options.follow_button=default_options.follow_button),1.5>MMD_options.version&&(MMD_options.version=1.5),storage_set("options",MMD_options)):Promise.all(t)})}function append_to_output_and_scroll(e,t){e.value+="\n"+t,e.scrollTop=e.scrollHeight}function fetch_mal_manga_list(e,t,a,n=0,o=!1){return append_to_output_and_scroll(a,"Fetching MyAnimeList manga from "+n+" to "+(n+300)),fetch("https://myanimelist.net/mangalist/"+t+"/load.json?offset="+n+"&status=7",{method:"GET",redirect:"follow",credentials:"include"}).then(function(l){return l.json()}).then(l=>{if(l.hasOwnProperty("errors"))append_to_output_and_scroll(a,l.errors[0].message);else{for(let r of l)e.push(r);if(300==l.length&&!o)return fetch_mal_manga_list(e,t,a,n+300);append_to_output_and_scroll(a,"Done fetching MyAnimeList manga.")}}).catch(l=>{console.error(l)})}function fetch_mangadex_manga(e,t,a=1,n=1){return append_to_output_and_scroll(t,"Fetching MangaDex follow page manga "+a+" of "+n),fetch("https://mangadex.org/follows/manga/0/0/"+a+"/",{method:"GET",redirect:"follow",credentials:"include"}).then(o=>{return o.text().then(l=>{for(let s,r=/<a\s*class='manga_title\s*'\s*title='.+'\s*href='\/manga\/(\d+)\/.+'>.+<\/a>/g;null!==(s=r.exec(l));)s.index===r.lastIndex&&r.lastIndex++,e.push(parseInt(s[1]));return 1==a&&(n=Math.ceil(/Showing\s\d+\sto\s\d+\sof\s(\d+)\stitles/.exec(l)[1]/100)),a<n?fetch_mangadex_manga(e,t,a+1,n):void append_to_output_and_scroll(t,"Done fetching MangaDex follow manga.")})}).catch(o=>{console.error(o)})}function update_all_manga_with_mal_data(e,t,a,n=0){return append_to_output_and_scroll(a,"Updating "+(n+1)+"/"+t.length),fetch("https://mangadex.org/manga/"+t[n],{method:"GET",cache:"no-cache"}).then(o=>{o.text().then(l=>{let r=/<title>(.+)\s\(Manga\)/.exec(l)[1];append_to_output_and_scroll(a,"-> "+r);let s=/<a.+href='(.+)'>MyAnimeList<\/a>/.exec(l),d={name:r,id:t[n],mal:0,last:0,current:{volume:0,chapter:0},chapters:[]};if(null===s)return append_to_output_and_scroll(a,"-> Set to Chapter 0 (No MyAnimeList entry)"),update_manga_local_storage(d).then(()=>{return n++,n<t.length?update_all_manga_with_mal_data(e,t,a,n):void(append_to_output_and_scroll(a,"Done. Refresh the page to see the new data."),vNotify.success({title:"All MyAnimeList data imported.",text:"Refresh the page to see the new data.",image:"https://i.imgur.com/oMV2BJt.png",sticky:!0}))});s=s[1],d.mal=parseInt(/.+\/(\d+)/.exec(s)[1]);for(var c of e)if(c.manga_id==d.mal){if(d.last=parseInt(c.num_read_chapters),MMD_options.save_all_opened){let u=Math.max(d.last-MMD_options.max_save_opened,0);for(let p=d.last;p>u;p--)d.chapters.push(p)}break}return append_to_output_and_scroll(a,"-> Set to Chapter "+d.last),update_manga_local_storage(d).then(()=>{n++,n<t.length?update_all_manga_with_mal_data(e,t,a,n):(append_to_output_and_scroll(a,"Done. Refresh the page to see the new data."),vNotify.success({title:"All MyAnimeList data imported.",text:"Refresh the page to see the new data.",image:"https://i.imgur.com/oMV2BJt.png",sticky:!0}))})})}).catch(o=>{console.error(o)})}function insert_mal_link_form(e,t){var a=document.querySelector(".col-xl-9.col-lg-8.col-md-7"),n=document.createElement("div");n.className="row m-0 py-1 px-0 border-top",n.id="add_mal_link_row";var o=document.createElement("div");o.className="col-lg-3 col-xl-2 strong",o.textContent="MAL link:";var l=document.createElement("div");l.className="col-lg-9 col-xl-10";var r=document.createElement("input");r.id="mymangadex-mal-link-input",r.className="form-control",r.style.display="inline-block",r.style.width="auto",r.style.verticalAlign="middle",r.type="text",r.size=40,r.placeholder="An url like https://myanimelist.net/manga/103939 or an id";var s=document.createElement("button");s.className="btn btn-default",s.type="submit",s.textContent="Send",s.addEventListener("click",()=>{if(""!=r.value){let c=/https:\/\/(?:www\.)?myanimelist\.net\/manga\/(\d+)(?:\/.+)?|(\d+)/.exec(r.value);null==c?vNotify.error({title:"Wrong input",text:"You can only an url like https://myanimelist.net/manga/2, https://myanimelist.net/manga/2/Berserk, or an id"}):(e.mal=parseInt(c[1])||parseInt(c[2]),0<e.mal?fetch_mal_for_manga_data(e).then(()=>{return e.more_info.exist?update_manga_local_storage(e,!1).then(()=>{insert_mal_informations(l,e),highlight_chapters(e,t),vNotify.success({title:"MyAnimeList id set",text:"Nice.",image:"https://i.imgur.com/oMV2BJt.png"})}):void vNotify.error({title:"The manga doesn't exist.",text:"Check the id maybe ?"})}):vNotify.error({title:"Wrong input",text:"id need to be > 0"}))}}),l.appendChild(r),l.appendChild(document.createTextNode(" ")),l.appendChild(s),n.appendChild(o),n.appendChild(l),a.insertBefore(n,a.lastElementChild)}function fetch_mal_for_manga_data(e){return fetch("https://myanimelist.net/ownlist/manga/"+e.mal+"/edit?hideLayout",{method:"GET",redirect:"follow",cache:"no-cache",credentials:"include"}).then(t=>{return e.more_info={},e.more_info.redirected=t.redirected,t.text().then(a=>{"401 Unauthorized"==a?(vNotify.error({title:"Not logged in",text:"Log in on MyAnimeList!",image:"https://i.imgur.com/oMV2BJt.png"}),logged_in_mal=!1):(csrf_token=/'csrf_token'\scontent='(.{40})'/.exec(a)[1],e.more_info.is_approved=!/class="badresult"/.test(a),e.more_info.exist=!/id="queryTitle"/.test(a),e.more_info.comments=/add_manga_comments.+>(.*)</.exec(a)[1],e.more_info.finish_date={},e.more_info.finish_date.month=parseInt(/add_manga_finish_date_month.+\s.+value="(\d+)?"\s*selected="selected"/.exec(a)[1])||"",e.more_info.finish_date.day=parseInt(/add_manga_finish_date_day.+\s.+value="(\d+)?"\s*selected="selected"/.exec(a)[1])||"",e.more_info.finish_date.year=parseInt(/add_manga_finish_date_year.+\s.+value="(\d+)?"\s*selected="selected"/.exec(a)[1])||"",e.more_info.ask_to_discuss=/add_manga_is_asked_to_discuss.+\s.+value="(\d+)?"\s*selected="selected"/.exec(a),e.more_info.ask_to_discuss=null===e.more_info.ask_to_discuss?0:parseInt(e.more_info.ask_to_discuss[1]),e.last_mal=/add_manga_num_read_chapters.+value="(\d+)?"/.exec(a),e.last_mal=null===e.last_mal?0:parseInt(e.last_mal[1]),e.more_info.total_reread=/add_manga_num_read_times.+value="(\d+)?"/.exec(a),e.more_info.total_reread=null===e.more_info.total_reread?0:parseInt(e.more_info.total_reread[1]),e.more_info.last_volume=/add_manga_num_read_volumes.+value="(\d+)?"/.exec(a),e.more_info.last_volume=null===e.more_info.last_volume?0:parseInt(e.more_info.last_volume[1]),e.more_info.retail_volumes=/add_manga_num_retail_volumes.+value="(\d+)?"/.exec(a),e.more_info.retail_volumes=null===e.more_info.retail_volumes?0:parseInt(e.more_info.retail_volumes[1]),e.more_info.priority=/add_manga_priority.+\s.+value="(\d+)?"\s*selected="selected"/.exec(a),e.more_info.priority=null===e.more_info.priority?0:parseInt(e.more_info.priority[1]),e.more_info.reread_value=/add_manga_reread_value.+\s.+value="(\d+)?"\s*selected="selected"/.exec(a),e.more_info.reread_value=null===e.more_info.reread_value?"":e.more_info.reread_value[1],e.more_info.score=/add_manga_score.+\s.+value="(\d+)?"\s*selected="selected"/.exec(a),e.more_info.score=null===e.more_info.score?"":parseInt(e.more_info.score[1]),e.more_info.sns_post_type=/add_manga_sns_post_type.+\s.+value="(\d+)?"\s*selected="selected"/.exec(a),e.more_info.sns_post_type=null===e.more_info.sns_post_type?0:parseInt(e.more_info.sns_post_type[1]),e.more_info.start_date={},e.more_info.start_date.month=parseInt(/add_manga_start_date_month.+\s.+value="(\d+)?"\s*selected="selected"/.exec(a)[1])||"",e.more_info.start_date.day=parseInt(/add_manga_start_date_day.+\s.+value="(\d+)?"\s*selected="selected"/.exec(a)[1])||"",e.more_info.start_date.year=parseInt(/add_manga_start_date_year.+\s.+value="(\d+)?"\s*selected="selected"/.exec(a)[1])||"",e.more_info.status=/add_manga_status.+\s.+value="(\d+)?"\s*selected="selected"/.exec(a),e.more_info.status=null===e.more_info.status?0:parseInt(e.more_info.status[1]),e.more_info.storage_type=/add_manga_storage_type.+\s.+value="(\d+)?"\s*selected="selected"/.exec(a),e.more_info.storage_type=null===e.more_info.storage_type?"":e.more_info.storage_type[1],e.more_info.tags=/add_manga_tags.+>(.*)*</.exec(a)[1]||"",e.more_info.is_rereading=0,e.more_info.total_volume=parseInt(/id="totalVol">(.*)?<\//.exec(a)[1])||0,e.more_info.total_chapter=parseInt(/id="totalChap">(.*)?<\//.exec(a)[1])||0)})}).catch(console.error)}function update_manga_last_read(e,t=!0,a=1){let n;return n=t?fetch_mal_for_manga_data(e):new Promise(o=>{return o()}),n.then(()=>{if(logged_in_mal)if(e.more_info.is_approved){let l="https://myanimelist.net/ownlist/manga/"+e.mal+"/edit?hideLayout",r=parseInt(e.more_info.status);if(t)if(0==e.last_mal||Math.floor(e.current.chapter)>e.last_mal){if(r=2==parseInt(e.more_info.status)||0<parseInt(e.more_info.total_chapter)&&e.current.chapter>=parseInt(e.more_info.total_chapter)?2:a,e.more_info.started=!1,6!=r&&(6==e.more_info.status||0==e.more_info.status)&&""==e.more_info.start_date.year){e.more_info.started=!0;let s=new Date;e.more_info.start_date.year=s.getFullYear(),e.more_info.start_date.month=s.getMonth()+1,e.more_info.start_date.day=s.getDate()}if(0==e.more_info.status&&(l="https://myanimelist.net/ownlist/manga/add?selected_manga_id="+e.mal_id+"&hideLayout"),2==r&&""==e.more_info.finish_date.year){let s=new Date;e.more_info.finish_date.year=s.getFullYear(),e.more_info.finish_date.month=s.getMonth()+1,e.more_info.finish_date.day=s.getDate()}e.last_mal=e.current.chapter,e.last_volume=e.current.volume,e.more_info.status=r}else return void vNotify.info({title:"Not updated",text:"Last read chapter on MyAnimelist is higher or equal to the current chapter, it wasn't updated.",image:"https://mangadex.org/images/manga/"+e.id+".thumb.jpg"});var o="";o+=encodeURIComponent("add_manga[comments]")+"="+encodeURIComponent(e.more_info.comments)+"&",o+=encodeURIComponent("add_manga[finish_date][day]")+"="+e.more_info.finish_date.day+"&",o+=encodeURIComponent("add_manga[finish_date][month]")+"="+e.more_info.finish_date.month+"&",o+=encodeURIComponent("add_manga[finish_date][year]")+"="+e.more_info.finish_date.year+"&",o+=encodeURIComponent("add_manga[is_asked_to_discuss]")+"="+e.more_info.ask_to_discuss+"&",o+=encodeURIComponent("add_manga[num_read_chapters]")+"="+Math.floor(e.current.chapter)+"&",o+=encodeURIComponent("add_manga[num_read_times]")+"="+e.more_info.total_reread+"&",o+=encodeURIComponent("add_manga[num_read_volumes]")+"="+e.current.volume+"&",o+=encodeURIComponent("add_manga[num_retail_volumes]")+"="+e.more_info.retail_volumes+"&",o+=encodeURIComponent("add_manga[priority]")+"="+e.more_info.priority+"&",o+=encodeURIComponent("add_manga[reread_value]")+"="+e.more_info.reread_value+"&",o+=encodeURIComponent("add_manga[score]")+"="+e.more_info.score+"&",o+=encodeURIComponent("add_manga[sns_post_type]")+"="+e.more_info.sns_post_type+"&",o+=encodeURIComponent("add_manga[start_date][day]")+"="+e.more_info.start_date.day+"&",o+=encodeURIComponent("add_manga[start_date][month]")+"="+e.more_info.start_date.month+"&",o+=encodeURIComponent("add_manga[start_date][year]")+"="+e.more_info.start_date.year+"&",o+=encodeURIComponent("add_manga[status]")+"="+r+"&",o+=encodeURIComponent("add_manga[storage_type]")+"="+e.more_info.storage_type+"&",o+=encodeURIComponent("add_manga[tags]")+"="+encodeURIComponent(e.more_info.tags)+"&",o+=encodeURIComponent("csrf_token")+"="+csrf_token+"&",o+="last_completed_vol=&",o+="manga_id="+e.mal+"&",o+="submitIt=0",fetch(l,{method:"POST",body:o,redirect:"follow",credentials:"include",headers:{"Content-Type":"application/x-www-form-urlencoded",accept:"text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8"}}).then(()=>{t&&(6==r?vNotify.success({title:"Added to Plan to Read",text:e.name+" as been put in your endless Plan to read list !",image:"https://mangadex.org/images/manga/"+e.id+".thumb.jpg"}):(0<e.last_mal&&vNotify.success({title:"Manga updated",text:e.name+" as been updated to chapter "+e.current.chapter+(0<parseInt(e.more_info.total_chapter)?" out of "+e.more_info.total_chapter:""),image:"https://mangadex.org/images/manga/"+e.id+".thumb.jpg"}),e.more_info.started&&vNotify.success({title:"Manga updated",text:"You started reading "+e.name,image:"https://mangadex.org/images/manga/"+e.id+".thumb.jpg"}),6!=r&&(0==e.more_info.status||6==e.more_info.status)&&vNotify.success({title:"Started manga",text:"The start date of "+e.name+" was set to today.",image:"https://mangadex.org/images/manga/"+e.id+".thumb.jpg"}),2==r&&vNotify.success({title:"Manga completed",text:e.name+" was set as completed.",image:"https://mangadex.org/images/manga/"+e.id+".thumb.jpg"})))}).catch(console.error)}else vNotify.info({title:"Not updated",text:"The manga is still pending approval on MyAnimelist and can't be updated.",image:"https://i.imgur.com/oMV2BJt.png"})})}function update_manga_local_storage(e,t=!0){return e.last=e.current.chapter>e.last&&MMD_options.last_only_higher||!MMD_options.last_only_higher?e.current.chapter:e.last,storage_set(e.id,{mal:e.mal,last:e.last,chapters:e.chapters}).then(()=>{t&&0==e.mal&&(e.current.chapter>e.last&&MMD_options.last_only_higher||!MMD_options.last_only_higher)&&vNotify.success({title:"Manga updated",text:e.name+" last open Chapter as been updated to "+(e.current.chapter>e.last&&MMD_options.last_only_higher||!MMD_options.last_only_higher?e.current.chapter:e.last),image:"https://mangadex.org/images/manga/"+e.id+".thumb.jpg"})})}function add_simple_input(e,t,a,n="",o=[]){let l=document.createElement(a);switch(a){case"text":l=document.createElement("input"),l.type="text";case"textarea":l.value=n;break;case"select":l.style.display="inline-block",l.style.width="auto";for(let r of o){let s=document.createElement("option");s.value=r.value,s.textContent=r.content||r.value,r.value==n&&(s.selected="selected"),l.appendChild(s)}}return l.className="form-control",e.appendChild(document.createTextNode(t)),e.appendChild(l),e.appendChild(document.createTextNode(" ")),l}function add_row(e,t,a="",n="",o=[],l=""){let r=document.createElement("tr"),s=document.createElement("td");s.textContent=t,r.appendChild(s);let c,d=document.createElement("td");if(""!=a){switch(c=document.createElement(a),a){case"text":c=document.createElement("input"),c.type="text",""!=l&&c.classList.add("mmd-half");case"textarea":c.value=n;break;case"a":c.textContent=n,c.href="https://myanimelist.net/manga/"+o,c.target="blank";break;case"select":for(let u of o){let p=document.createElement("option");p.value=u.value,p.textContent=u.content||u.value,u.value==n&&(p.selected="selected"),c.appendChild(p)}}c.classList.add("form-control"),d.appendChild(c),""!=l&&d.appendChild(document.createTextNode(l))}return r.appendChild(d),e.appendChild(r),""==a?d:c}function insert_mal_button(e,t,a){var n=document.createElement("a");n.title="Edit on MyAnimeList",a?(n.className="btn btn-secondary float-right mr-1",append_text_with_icon(n,"edit","Edit on MyAnimeList")):(n.className="btn btn-secondary col m-1",append_text_with_icon(n,"edit","")),n.addEventListener("click",()=>{let l=document.getElementById("mmd-modal-container");if(l)l.style.display="block",l.firstElementChild.classList.add("mmd-opening"),setTimeout(()=>{l.firstElementChild.classList.remove("mmd-opening")},500);else{let r=document.createElement("div");r.id="mmd-modal-container",r.className="mmd-fadein";let s=document.createElement("div");s.id="mmd-modal",s.className="mmd-opening";let d=document.createElement("span");d.className="mmd-close-button",d.textContent="\xD7",d.addEventListener("click",w=>{w.preventDefault(),r.style.display="none"});let c=document.createElement("h1");c.textContent="Edit informations";let u=document.createElement("table");u.className="mmd-content";let p=document.createElement("tbody"),h={start_date:{},finish_date:{}},_=document.createElement("a");_.className="btn btn-success mmd-save";let f=document.createElement("span");f.className="fas fa-save",_.appendChild(f),_.appendChild(document.createTextNode(" Save")),_.addEventListener("click",w=>{for(let N in w.target.disabled=!0,h)t.more_info[N]="start_date"==N||"finish_date"==N?{month:h[N].month.value,day:h[N].day.value,year:h[N].year.value}:h[N].value;t.current.volume=parseInt(h.last_volume.value),t.current.chapter=parseInt(h.last_mal.value),t.last_mal=parseInt(h.last_mal.value),update_manga_last_read(t,!1).then(()=>{a&&(clear_dom_node(e),insert_mal_informations(e,t)),r.style.display="none",vNotify.success({title:"Manga Updated",image:"https://i.imgur.com/oMV2BJt.png"})})}),u.appendChild(_);let g=[{value:"",content:""},{value:1,content:"Jan"},{value:2,content:"Feb"},{value:3,content:"Mar"},{value:4,content:"Apr"},{value:5,content:"May"},{value:6,content:"June"},{value:7,content:"Jul"},{value:8,content:"Aug"},{value:9,content:"Sep"},{value:10,content:"Oct"},{value:11,content:"Nov"},{value:12,content:"Dec"}],v=[{value:""},{value:1},{value:2},{value:3},{value:4},{value:5},{value:6},{value:7},{value:8},{value:9},{value:10},{value:11},{value:12},{value:13},{value:14},{value:15},{value:16},{value:17},{value:18},{value:19},{value:20},{value:21},{value:22},{value:23},{value:24},{value:25},{value:26},{value:27},{value:28},{value:29},{value:30},{value:31}],y=[{value:""},{value:2018},{value:2017},{value:2016},{value:2015},{value:2014},{value:2013},{value:2012},{value:2011},{value:2010},{value:2009},{value:2008},{value:2007},{value:2006},{value:2005},{value:2004},{value:2003},{value:2002},{value:2001},{value:2e3},{value:1999},{value:1998},{value:1997},{value:1996},{value:1995},{value:1994},{value:1993},{value:1992},{value:1991},{value:1990},{value:1989},{value:1988}];add_row(p,"Title","a",t.name,t.mal,"Click to open in a new tab"),h.status=add_row(p,"Status","select",t.more_info.status,[{value:1,content:"Reading"},{value:2,content:"Completed"},{value:3,content:"On-Hold"},{value:4,content:"Dropped"},{value:6,content:"Plan to Read"}]),h.last_volume=add_row(p,"Volumes Read","text",t.more_info.last_volume,{}," / "+t.more_info.total_volume),h.last_mal=add_row(p,"Chapters Read","text",t.last_mal,{}," / "+t.more_info.total_chapter),h.score=add_row(p,"Your Score","select",t.more_info.score,[{value:"",content:"Select score"},{value:10,content:"(10) Masterpiece"},{value:9,content:"(9) Great"},{value:8,content:"(8) Very Good"},{value:7,content:"(7) Good"},{value:6,content:"(6) Fine"},{value:5,content:"(5) Average"},{value:4,content:"(4) Bad"},{value:3,content:"(3) Very Bad"},{value:2,content:"(2) Horrible"},{value:1,content:"(1) Appalling"}]);let C=add_row(p,"Start Date");h.start_date.month=add_simple_input(C,"Month: ","select",t.more_info.start_date.month,g),h.start_date.day=add_simple_input(C,"Day: ","select",t.more_info.start_date.day,v),h.start_date.year=add_simple_input(C,"Year: ","select",t.more_info.start_date.year,y);let E=document.createElement("a");E.textContent="Insert Today",E.addEventListener("click",()=>{let N=new Date;h.start_date.month.value=N.getMonth()+1,h.start_date.day.value=N.getDate(),h.start_date.year.value=N.getFullYear()}),C.appendChild(E);let b=add_row(p,"Finish Date");h.finish_date.month=add_simple_input(b,"Month: ","select",t.more_info.finish_date.month,g),h.finish_date.day=add_simple_input(b,"Day: ","select",t.more_info.finish_date.day,v),h.finish_date.year=add_simple_input(b,"Year: ","select",t.more_info.finish_date.year,y);let k=document.createElement("a");k.textContent="Insert Today",k.addEventListener("click",()=>{let N=new Date;h.finish_date.month.value=N.getMonth()+1,h.finish_date.day.value=N.getDate(),h.finish_date.year.value=N.getFullYear()}),b.appendChild(k),h.tags=add_row(p,"Tags","textarea",t.more_info.tags),h.priority=add_row(p,"Priority","select",t.more_info.priority,[{value:0,content:"Low"},{value:1,content:"Medium"},{value:2,content:"High"}]),h.storage=add_row(p,"Storage","select",t.more_info.storage,[{value:"",content:"None"},{value:1,content:"Hard Drive"},{value:6,content:"External HD"},{value:7,content:"NAS"},{value:8,content:"Blu-ray"},{value:2,content:"DVD / CD"},{value:4,content:"Retail Manga"},{value:5,content:"Magazine"}]),h.retail_volumes=add_row(p,"How many volumes?","text",t.more_info.retail_volumes),h.total_reread=add_row(p,"Total Times Re-read","text",t.more_info.total_reread),h.reread_value=add_row(p,"Re-read Value","select",t.more_info.reread_value,[{value:"",content:"Select reread value"},{value:1,content:"Very Low"},{value:2,content:"Low"},{value:3,content:"Medium"},{value:4,content:"High"},{value:5,content:"Very High"}]),h.comments=add_row(p,"Comments","textarea",t.more_info.comments),h.ask_to_discuss=add_row(p,"Ask to Discuss?","select",t.more_info.ask_to_discuss,[{value:0,content:"Ask to discuss a chapter after you update the chapter #"},{value:1,content:"Don't ask to discuss"}]),h.sns_post_type=add_row(p,"Post to SNS","select",t.more_info.sns_post_type,[{value:0,content:"Follow default setting"},{value:1,content:"Post with confirmation"},{value:2,content:"Post every time (without confirmation)"},{value:3,content:"Do not post"}]),s.appendChild(d),s.appendChild(c),u.appendChild(p),s.appendChild(u),r.appendChild(s),document.body.appendChild(r),setTimeout(()=>{s.classList.remove("mmd-opening")},500)}}),e.appendChild(n)}function append_status(e,t){let o=[{color:"blueviolet",text:"Not on the list"},{color:"cornflowerblue",text:"Reading"},{color:"darkseagreen",text:"Completed"},{color:"orange",text:"On-Hold"},{color:"firebrick",text:"Dropped"},null,{color:"violet",text:"Plan to Read"}],l=document.createElement("span");l.style.color=o[e].color,l.textContent=o[e].text,t.appendChild(l)}function clear_dom_node(e){for(;e.firstChild;)e.removeChild(e.firstChild)}function insert_mal_informations(e,t){clear_dom_node(e),insert_mal_button(e,t,!0),append_status(t.more_info.status,e),e.appendChild(document.createElement("br")),append_text_with_icon(e,"book","Volume "+t.more_info.last_volume+(0<parseInt(t.more_info.total_volume)?" out of "+t.more_info.total_volume:"")),e.appendChild(document.createElement("br")),append_text_with_icon(e,"bookmark","Chapter "+t.last_mal+(0<parseInt(t.more_info.total_chapter)?" out of "+t.more_info.total_chapter:"")),e.appendChild(document.createElement("br")),""!=t.more_info.start_date.year&&(append_text_with_icon(e,"calendar-alt","Start date "+t.more_info.start_date.year+"/"+t.more_info.start_date.month+"/"+t.more_info.start_date.day),e.appendChild(document.createElement("br"))),2==t.more_info.status&&""!=t.more_info.finish_date.year&&(append_text_with_icon(e,"calendar-alt","Finish date "+t.more_info.finish_date.year+"/"+t.more_info.finish_date.month+"/"+t.more_info.finish_date.day),e.appendChild(document.createElement("br")));let a;a=""==t.more_info.score?"Not scored yet":"Scored "+t.more_info.score+" out of 10",append_text_with_icon(e,"star",a)}function highlight_chapters(e,t){for(let a of t)if(e.last_mal==parseInt(a.chapter))a.node.style.backgroundColor=MMD_options.colors.last_read;else if(e.last==a.chapter)a.node.style.backgroundColor=MMD_options.colors.last_open[0];else if(MMD_options.save_all_opened)for(let n of e.chapters)if(a.chapter==n){a.node.style.backgroundColor=MMD_options.colors.opened_chapters;break}}function add_to_mal_list(e,t,a){a.textContent="Loading...",update_manga_last_read(e,!0,t).then(()=>{insert_mal_informations(a,e)})}function volume_and_chapter_from_node(e){let t=e.getAttribute("data-chapter");return""==t?volume_and_chapter_from_string(e.children[1].textContent):{volume:parseInt(e.getAttribute("data-volume"))||0,chapter:parseFloat(t)||1}}function volume_and_chapter_from_string(e){let t=/(?:Vol(?:[.]|ume)\s([0-9]+)\s)?(?:Ch(?:[.]|apter)\s)?([0-9]+)([.][0-9]+)?/.exec(e);return null==t&&(t=[0,0,1,void 0]),{volume:parseInt(t[1])||0,chapter:parseFloat(t[2]+""+t[3])}}function create_nav_button(e,t,a,n){var o=document.createElement("li");o.className="nav-item",o.setAttribute("is-a-mmd-button",!0);var l=document.createElement("a");append_text_with_icon(l,a,""),l.href="#",l.className="nav-link",l.appendChild(document.createTextNode(" "+t)),l.addEventListener("click",n),o.appendChild(l),e.insertBefore(o,e.lastElementChild)}function activate_button(e){document.querySelectorAll("li[is-a-mmd-button='true']").forEach(t=>{t.className=""}),e.parentElement.classList.toggle("active")}function display_or_hide_container(e,t,a,n){return"none"==a.style.display||t!=e?(clear_dom_node(a),a.style.display="block",!1):(a.style.display="none",n.parentElement.classList.toggle("active"),!0)}function append_text_with_icon(e,t,a){let n=document.createElement("span");n.className="fas fa-"+t+" fa-fw",n.setAttribute("aria-hidden",!0),e.appendChild(n),e.appendChild(document.createTextNode(" ")),e.appendChild(document.createTextNode(a))}function tooltip(e,t,a,n=void 0){e.addEventListener("mouseenter",o=>{o.preventDefault();let l=document.getElementById("tooltip-"+t);if(null===l){let r=document.createElement("div");r.className="mmd-tooltip mmd-active",r.id="tooltip-"+t;let s=document.createElement("img");s.src="https://mangadex.org/images/manga/"+a+".thumb.jpg";let d=o.target.getBoundingClientRect(),c=window.scrollY;if(r.style.width="100px",r.style.left=d.x-105+"px",r.style.top=d.y+d.height/2+c-143/2+"px",s.addEventListener("load",()=>{let u=s.getBoundingClientRect();r.style.left=d.x-u.width-5+"px",r.style.top=d.y+d.height/2+c-u.height/2+"px",r.style.maxWidth=u.width+2+"px"}),r.appendChild(s),MMD_options.save_all_opened&&void 0!==n&&void 0!==n.chapters&&0<n.chapters.length){s.className="mmd-tooltip-image";let u=document.createElement("div");u.className="mmd-tooltip-content";let p=Math.min(5,n.chapters.length);for(let h=0;h<p;h++)append_text_with_icon(u,"eye",n.chapters[h]),u.appendChild(document.createElement("br"));r.appendChild(u)}document.getElementById("mmd-tooltip").appendChild(r)}else l.classList.add("mmd-active")}),e.addEventListener("mouseleave",o=>{o.preventDefault();let l=document.getElementById("tooltip-"+t);null!==l&&l.classList.remove("mmd-active")})}function insert_chapter(e,t){if(-1===e.indexOf(t))if(0==e.length)e.push(t);else{let a=0,n=e.length,o=!0;for(;a<n&&o;)e[a]<t?o=!1:a++;for(e.splice(a,0,t);e.length>MMD_options.max_save_opened;)e.pop()}}function start(){-1<URL.indexOf("org/follows")||-1<URL.indexOf("org/group")&&(-1<URL.indexOf("/chapters/")||-1==URL.indexOf("/manga/")&&-1==URL.indexOf("/comments/"))||-1<URL.indexOf("org/user")&&(-1<URL.indexOf("/chapters/")||-1==URL.indexOf("/manga/"))?follow_page(!(-1<URL.indexOf("org/group")||-1<URL.indexOf("org/user"))):-1<URL.indexOf("org/manga")?manga_page():-1<URL.indexOf("org/chapter")?chapter_page():(-1<URL.indexOf("org/search")||-1<URL.indexOf("org/?page=search")||-1<URL.indexOf("org/?page=titles")||-1<URL.indexOf("org/featured")||-1<URL.indexOf("org/titles")||-1<URL.indexOf("org/list")||-1<URL.indexOf("org/group")&&-1<URL.indexOf("/manga/")||-1<URL.indexOf("org/user")&&-1<URL.indexOf("/manga/"))&&search_and_list_page()}function follow_page(e){let t=document.querySelector(".chapter-container").children;var a={},n=MMD_options.colors.last_open.length,o=0;let l=document.createElement("div");l.id="mmd-tooltip",document.body.appendChild(l);let r={},s=t.length-1;for(let u=s;0<u;--u){let p=t[u],h=volume_and_chapter_from_node(p.lastElementChild.firstElementChild);if(0<p.firstElementChild.childElementCount){let _=parseInt(/\/manga\/(\d+)\//.exec(p.firstElementChild.firstElementChild.href)[1]),f={};is_empty(a)||(a.dom_nodes.push(p),a.chapters.push(h),f={dom_nodes:a.dom_nodes,chapters:a.chapters}),a={};let g=r[_];r[_]===void 0&&(r[_]=storage_get(_),g=r[_]),g.then(v=>{let y=!0;if(v!==void 0){let C=MMD_options.colors.last_open[o];if(is_empty(f))h.chapter==v.last?(p.style.backgroundColor=C,o=(o+1)%n):h.chapter<v.last?(y=!1,MMD_options.hide_lower?p.parentElement.removeChild(p):p.style.backgroundColor=MMD_options.colors.lower_chapter):(p.children[2].firstElementChild.addEventListener("auxclick",()=>{p.style.backgroundColor=C}),o=(o+1)%n);else{let E=!1,b=!1,k=f.chapters.length-1;for(let w in f.chapters){let N=f.chapters[w].chapter,L=f.dom_nodes[w],M=!0;N<v.last&&(parseInt(w)<k||parseInt(w)==k&&!E&&!b)?(M=!1,parseInt(w)==k&&(y=!1),MMD_options.hide_lower?L.parentElement.removeChild(L):L.style.backgroundColor=MMD_options.colors.lower_chapter):N==v.last?(E=!0,L.style.backgroundColor=C,o=(o+1)%n):(b=!0,E&&(L.firstElementChild.style.backgroundColor=C),L.children[2].firstElementChild.addEventListener("auxclick",()=>{L.style.backgroundColor=C}))}}}y&&tooltip(p,u,_,v)})}else is_empty(a)?a={dom_nodes:[p],chapters:[h]}:(a.dom_nodes.push(p),a.chapters.push(h))}if(e){let u=document.createElement("div");u.className="form-group",u.style.display="none",u.style.padding="15px 0 0 0",u.style.textAlign="center";let p=document.getElementById("chapters");p.style.clear="both",p.parentElement.insertBefore(u,p);let h=document.querySelector(".nav.nav-tabs");var d=0,c=!0;create_nav_button(h,"Import (MMD)","upload",_=>{if(_.preventDefault(),c){if(activate_button(_.target),display_or_hide_container(2,d,u,_.target))return;d=2;let f=document.createElement("label");f.className="col-sm-3 control-label",f.textContent="JSON Data: ";let g=document.createElement("div"),v=document.createElement("textarea");v.className="form-control";let y=document.createElement("div");y.style.textAlign="right";let C=document.createElement("label"),E=document.createElement("input");E.type="checkbox",E.style.margin="0 5px",E.style.verticalAlign="middle",E.value="Merge",C.appendChild(E),C.appendChild(document.createTextNode("Merge"));let b=document.createElement("button");b.className="btn btn-default",b.style.margin="15px 0",append_text_with_icon(b,"save","Send"),y.appendChild(C),y.appendChild(document.createTextNode(" ")),y.appendChild(b),b.addEventListener("click",k=>{k.preventDefault(),c=!1;try{let w=JSON.parse(v.value);if(E.checked){let N=[];for(let L in w)"options"==L?N.push(storage_set("options",w[L])):N.push(storage_get(L).then(M=>{let D=w[L+""];if(void 0!==M)if(D.last=Math.max(M.last,D.last),void 0!==D.chapters){for(let A of M.chapters)insert_chapter(D.chapters,A);for(;D.chapters.length>MMD_options.max_save_opened;)D.chapters.pop()}else D.chapters=M.chapters||[];return storage_set(L,D)}));Promise.all(N).then(()=>{c=!0,vNotify.success({title:"Data imported",text:"Your data was successfully imported and merged !\nRefresh the page to see the modifications.",sticky:!0})})}else storage_set(null,w).then(()=>{c=!0,vNotify.success({title:"Data imported",text:"Your data was successfully imported !\nRefresh the page to see the modifications.",sticky:!0})})}catch(w){c=!0,vNotify.error({title:"Error importing",text:w,sticky:!0}),console.error(w)}_.target.parentElement.classList.toggle("active"),u.style.display="none"}),u.appendChild(f),g.appendChild(v),g.appendChild(y),u.appendChild(g)}}),create_nav_button(h,"Import (MAL)","upload",_=>{if(_.preventDefault(),c){if(activate_button(_.target),display_or_hide_container(4,d,u,_.target))return;d=4;let f=document.createElement("textarea");f.className="form-control",f.style.height="300px",f.style.overflow="auto",f.readOnly=!0,f.value="Loading... Don't close the browser tab or \"Import (MAL)\" tab.";let g=document.createElement("input");g.className="form-control",g.style.margin="0 auto",g.style.display="inline-block",g.style.width="auto",g.placeholder="MyAnimeList username",u.appendChild(g),u.appendChild(document.createTextNode(" "));let v=document.createElement("button");v.className="btn btn-success",v.style.margin="0 auto",v.style.display="inline-block",append_text_with_icon(v,"check","Import data from MyAnimeList"),v.addEventListener("click",y=>{if(y.preventDefault(),""!=g.value){c=!1;let C=[],E=[];fetch_mal_manga_list(C,g.value,f,0,!0).then(()=>{0==C.length?(c=!0,vNotify.error({title:"Can't fetch",text:"The list of this user isn't accessible, maybe you are not logged in on MyAnimeList ?",image:"https://i.imgur.com/oMV2BJt.png"})):(y.target.parentElement.removeChild(y.target),g.parentElement.removeChild(g),u.appendChild(f),Promise.all([fetch_mal_manga_list(C,g.value,f,C.length),fetch_mangadex_manga(E,f)]).then(()=>{update_all_manga_with_mal_data(C,E,f).then(()=>{c=!0})}))})}else vNotify.error({title:"Empty username",text:"Can't import a non-existing user ?!",image:"https://i.imgur.com/oMV2BJt.png"})}),u.appendChild(v)}}),create_nav_button(h,"Export (MMD)","download",_=>{if(_.preventDefault(),c){if(activate_button(_.target),display_or_hide_container(1,d,u,_.target))return;d=1;let f=document.createElement("textarea");f.className="form-control",f.style.height="300px",f.style.overflow="auto",f.value="Loading...",f.readOnly=!0,storage_get(null).then(v=>{f.value=JSON.stringify(v)});let g=document.createElement("button");g.className="btn btn-default",g.style.float="right",g.style.margin="15px",append_text_with_icon(g,"copy","Copy"),g.addEventListener("click",v=>{v.preventDefault();try{f.select(),document.execCommand("Copy"),vNotify.success({title:"Data copied",text:"Your data is in your Clipboard."})}catch(y){vNotify.error({title:"Error copying data",text:y,sticky:!0}),console.error(y)}}),u.appendChild(f),u.appendChild(g)}}),create_nav_button(h,"Clear Data (MMD)","trash",_=>{if(_.preventDefault(),c){if(activate_button(_.target),display_or_hide_container(3,d,u,_.target))return;d=3;let f=document.createElement("button");f.className="btn btn-danger",f.style.margin="0 auto",f.style.display="block",append_text_with_icon(f,"trash","Click here to Delete MyMangaDex local storage"),f.addEventListener("click",g=>{g.preventDefault(),c=!1,browser.storage.local.clear().then(()=>{c=!0,vNotify.success({title:"Data deleted",text:"Local storage as been cleared."})}),storage_set("options",MMD_options),_.target.parentElement.classList.toggle("active"),u.style.display="none"}),u.appendChild(f)}})}}function manga_page(){let e={name:document.querySelector("h6[class='card-header']").textContent.trim(),id:parseInt(/.+manga\/(\d+)/.exec(URL)[1]),mal:0,last:0,current:{volume:0,chapter:0},chapters:[]},t=[];var a=document.querySelector(".chapter-container").children;let n=a.length;for(let r,l=1;l<n;l++){r=a[l];var o=volume_and_chapter_from_node(r.firstElementChild.firstElementChild);t.push({node:r,chapter:o.chapter,volume:o.volume})}storage_get(e.id).then(l=>{let r=!1,s=document.querySelector("img[src='/images/misc/mal.png'");l===void 0?(r=!0,e.last=0,null===s?vNotify.error({title:"No MyAnimeList id found",text:"You can add one using the form.\nLast open chapter will still be saved.",sticky:!0}):(s=s.nextElementSibling.href,e.mal=parseInt(/.+\/(\d+)/.exec(s)[1])),update_manga_local_storage(e,!1)):(e.mal=l.mal,0==e.mal&&null!==s&&(s=s.nextElementSibling.href,e.mal=parseInt(/.+\/(\d+)/.exec(s)[1]),r=!0),e.last=l.last,e.chapters=l.chapters||[]),0<e.mal?fetch_mal_for_manga_data(e).then(()=>{if(logged_in_mal){var c=document.querySelector(".col-xl-9.col-lg-8.col-md-7"),u=document.createElement("div");u.className="row m-0 py-1 px-0 border-top";var p=document.createElement("div");p.className="col-lg-3 col-xl-2 strong",p.textContent="Status:";var h=document.createElement("div");if(h.className="col-lg-9 col-xl-10",!e.more_info.is_approved){let g=document.createElement("span");g.style.color="firebrick",g.textContent="The manga is still pending approval on MyAnimelist and can't be updated",h.appendChild(g)}else if(!1==e.more_info.redirected)insert_mal_informations(h,e),r&&(e.last=Math.max(e.last_mal,e.last),insert_chapter(e.chapters,e.last),update_manga_local_storage(e,!1));else{var _=document.createElement("button");_.className="btn btn-default",_.textContent="Start Reading",_.addEventListener("click",()=>{add_to_mal_list(e,1,h)});var f=document.createElement("button");f.className="btn btn-default",f.textContent="Add to Plan to Read list",f.addEventListener("click",()=>{add_to_mal_list(e,6,h)}),h.appendChild(_),h.appendChild(document.createTextNode(" ")),h.appendChild(f)}highlight_chapters(e,t),u.appendChild(p),u.appendChild(h),c.insertBefore(u,c.lastElementChild)}}):(insert_mal_link_form(e,t),highlight_chapters(e,t))},l=>{console.error("Error fetching data from local storage.",l)})}function chapter_page(){let e={name:"",id:0,chapter_id:0,mal:0,last:0,current:0,chapters:[],mal_checked:!1};if(chapter_info=document.querySelector("meta[property='og:title']").content,e.current=volume_and_chapter_from_string(chapter_info),e.name=/.*\((.+)\)/.exec(chapter_info)[1],chapter_info=document.querySelector("meta[property='og:image']").content,e.id=parseInt(/manga\/(\d+)\.thumb.+/.exec(chapter_info)[1]),e.chapter_id=parseInt(document.querySelector("meta[name='app']").dataset.chapterId),0==document.getElementsByClassName("card-header").length){var t=new MutationObserver(n=>{for(var o of n)if("attributes"==o.type){let l=parseInt(document.querySelector(".chapter-title").dataset.chapterId);e.chapter_id!=l&&(e.chapter_id=l,fetch("https://mangadex.org/api/chapter/"+e.chapter_id+"?").then(r=>r.json()).then(r=>{e.current.chapter=parseInt(r.chapter),e.current.volume=parseInt(r.volume)||0,e.mal_checked&&0<e.mal&&update_manga_last_read(e),MMD_options.save_all_opened&&insert_chapter(e.chapters,e.current.chapter),update_manga_local_storage(e)}))}});t.observe(document.querySelector(".chapter-title"),{attributes:!0})}check_manga_for_mal_id(e)}function check_manga_for_mal_id(e){return storage_get(e.id).then(t=>{let a=[];t===void 0?(vNotify.info({title:"No MyAnimeList id in storage",text:"Fetching MangaDex manga page of "+e.name+" to find a MyAnimeList id."}),e.last=e.current.chapter,MMD_options.save_all_opened&&e.chapters.push(e.last),a.push(fetch("https://mangadex.org/manga/"+e.id,{method:"GET",cache:"no-cache"}).then(n=>{n.text().then(o=>{let l=/<a.+href='(.+)'>MyAnimeList<\/a>/.exec(o);null===l?vNotify.error({title:"No MyAnimeList id found",text:"You can add one using the form.\nLast open chapter is still saved.",sticky:!0}):e.mal=parseInt(/.+\/(\d+)/.exec(l[1])[1])})},n=>{console.error(n)}))):(e.mal=t.mal,e.last=t.last,e.chapters=t.chapters||[],MMD_options.save_all_opened&&insert_chapter(e.chapters,e.current.chapter)),Promise.all(a).then(()=>{0<e.mal&&update_manga_last_read(e).then(()=>{e.more_info.exist&&e.more_info.is_approved&&insert_mal_button(document.querySelector(".reader-controls-actions.col-auto.row.no-gutters.p-1").lastElementChild,e,!1)}),e.mal_checked=!0,update_manga_local_storage(e)})},t=>{console.error("Error fetching data from local storage.",t)})}function search_and_list_page(){let e=document.querySelectorAll(".row.m-0.border-bottom"),t=e.length;if(0!=t){let a=document.createElement("div");a.id="mmd-tooltip",document.body.appendChild(a);for(let o,n=1;n<t;n++)o=/manga\/(\d+)\/?.*/.exec(e[n].firstElementChild.firstElementChild.firstElementChild.children[1].href)[1],tooltip(e[n],n,o)}}load_options().then(start);