/**
 * Author: Glagan
 * See <https://github.com/Glagan/MyMangaDex> for more informations
 */
let default_options={colors:{last_read:"rgba(95, 158, 160, 0.6)",lower_chapter:"darkolivegreen",last_open:["rgba(102, 51, 153, 0.6)","rgba(75, 0, 130, 0.6)"],opened_chapters:"darkslategray"},hide_lower:!0,last_only_higher:!0,save_all_opened:!0,max_save_opened:100,auto_md_list:!1,version:1.7},current_options=JSON.parse(JSON.stringify(default_options)),options_fields={colors:{last_read:{type:"input",node:document.getElementById("last_read")},lower_chapter:{type:"input",node:document.getElementById("lower_chapter")},last_open:[],opened_chapters:{type:"input",node:document.getElementById("opened_chapters")}},hide_lower:{type:"checkbox",node:document.getElementById("hide_lower")},last_only_higher:{type:"checkbox",node:document.getElementById("last_only_higher")},save_all_opened:{type:"checkbox",node:document.getElementById("save_all_opened")},auto_md_list:{type:"checkbox",node:document.getElementById("auto_md_list")},max_save_opened:{type:"input",node:document.getElementById("max_save_opened")}},current_panel=null,current_panel_button=null;function flash_background(a){document.getElementById("content").classList.add(a),setTimeout(()=>{document.getElementById("content").classList.remove(a)},500)}function saveOptions(a){return a.preventDefault(),Object.keys(options_fields).forEach(b=>{"colors"==b?Object.keys(options_fields.colors).forEach(c=>{"last_open"==c?(current_options.colors.last_open=[],options_fields.colors.last_open.forEach(d=>{current_options.colors.last_open.push(d.node.value)})):current_options.colors[c]=options_fields.colors[c].node.value}):"input"==options_fields[b].type?current_options[b]=options_fields[b].node.value:current_options[b]=options_fields[b].node.checked}),storage_set("options",current_options).then(()=>{console.log("Saved"),flash_background("mmd-saved")}).catch(b=>{console.error(b),flash_background("mmd-not-saved")})}function restoreOptions(){return storage_get("options").then(a=>{current_options=void 0==a?JSON.parse(JSON.stringify(default_options)):JSON.parse(JSON.stringify(a));let b=current_options.colors.last_open;deleteLastOpenColors(),b.forEach(c=>{addColor(c)}),Object.keys(options_fields).forEach(c=>{"colors"==c?Object.keys(options_fields.colors).forEach(d=>{"last_open"!=d&&(document.getElementById(d).value=current_options.colors[d])}):"input"==options_fields[c].type?document.getElementById(c).value=current_options[c]:document.getElementById(c).checked=current_options[c]}),changeColorBox(document.getElementById("box_last_read"),current_options.colors.last_read),changeColorBox(document.getElementById("box_lower_chapter"),current_options.colors.lower_chapter),changeColorBox(document.getElementById("box_opened_chapters"),current_options.colors.opened_chapters)})}function restoreDefaultsLastOpen(){deleteLastOpenColors(),default_options.colors.last_open.forEach(a=>{addColor(a)})}function restoreDefault(a){let b=/default_(.+)/.exec(a.target.id)[1],c=document.getElementById(b);if("last_open"==b)restoreDefaultsLastOpen();else if("text"!=c.type&&"number"!=c.type)c.checked=default_options.colors[b]?default_options.colors[b]:default_options[b];else if(c.value=default_options.colors[b]||default_options[b],"id"in c.dataset){let d=document.getElementById("box_"+c.dataset.id);d.style.backgroundColor=c.value}}function changeColorBox(a,b){a.style.backgroundColor=b}function addColor(a=""){let b=document.getElementById("last_open");current_options.colors.last_open.push(a);let c=current_options.colors.last_open.length-1,d=document.createElement("li");d.id="last_open_"+c;let e=document.createElement("i");e.className="fas fa-trash";let f=document.createElement("span");f.textContent="Remove",f.addEventListener("click",()=>{removeColor(c)});let g=document.createElement("span");g.className="color-box";let h=document.createElement("input");h.dataset.id=c,h.type="text",h.className="color-input",h.value=a,h.addEventListener("input",j=>{current_options.colors.last_open[c]=j.target.value,changeColorBox(g,j.target.value)}),options_fields.colors.last_open.push({type:"input",node:h}),d.appendChild(e),d.appendChild(document.createTextNode(" ")),d.appendChild(f),d.appendChild(document.createTextNode(" ")),d.appendChild(h),d.appendChild(g),b.insertBefore(d,b.lastElementChild),changeColorBox(g,a)}function removeColor(a){if(1<current_options.colors.last_open.length){let b=document.getElementById("last_open_"+a);return b.parentElement.removeChild(b),current_options.colors.last_open.splice(a,1),options_fields.colors.last_open.splice(a,1),!0}return!1}function openPanel(a){let b;b="I"==a.target.tagName?a.target.parentElement:a.target,b.classList.toggle("btn-primary"),null!=current_panel_button&&current_panel_button!=b&&current_panel_button.classList.toggle("btn-primary"),current_panel_button=b;let c=current_panel;null!=c&&c.classList.remove("open"),current_panel=document.getElementById(b.dataset.panel),current_panel==c?(current_panel=null,current_panel_button=null):null!=current_panel&&current_panel.classList.add("open")}function deleteLastOpenColors(){for(let a=document.getElementById("last_open");a.firstChild&&!("add_color_row"==a.firstChild.id);)a.removeChild(a.firstChild);current_options.colors.last_open=[],options_fields.colors.last_open=[]}function deleteSave(){browser.storage.local.clear(),storage_set("options",default_options).then(()=>{openPanel({target:document.getElementById("open-delete")}),flash_background("mmd-saved"),restoreOptions()}).catch(a=>{console.error(a),flash_background("mmd-not-saved")})}function importMMD(){try{let a=JSON.parse(document.getElementById("save-import-content").value),b=[];if(document.getElementById("save-merge").checked)for(let c in a)"options"==c?b.push(storage_set("options",a[c])):b.push(storage_get(c).then(d=>{let e=a[c+""],f=d[c];if(void 0!==f)if(e.last=Math.max(f.last,e.last),void 0!==e.chapters){for(let g of f.chapters)insert_chapter(e.chapters,g);for(;e.chapters.length>current_options.max_save_opened;)e.chapters.pop()}else e.chapters=f.chapters||[];return storage_set(c,e)}));else b.push(storage_set(null,a));Promise.all(b).then(()=>{openPanel({target:document.getElementById("open-import")}),restoreOptions(),flash_background("mmd-saved"),document.getElementById("save-import-content").value=""})}catch(a){flash_background("mmd-not-saved"),console.error(a)}}function append_to_output_and_scroll(a,b){a.value+="\n"+b,a.scrollTop=a.scrollHeight}function update_manga_local_storage(a){return a.last=a.current.chapter>a.last&&current_options.last_only_higher||!current_options.last_only_higher?a.current.chapter:a.last,storage_set(a.id,{mal:a.mal,last:a.last,chapters:a.chapters})}function fetch_mal_manga_list(a,b,c,d=0,e=!1){return 0<d&&300>d?void append_to_output_and_scroll(c,"Done fetching MyAnimeList manga."):(append_to_output_and_scroll(c,"Fetching MyAnimeList manga from "+d+" to "+(d+300)),fetch("https://myanimelist.net/mangalist/"+b+"/load.json?offset="+d+"&status=7",{method:"GET",redirect:"follow",credentials:"include"}).then(f=>f.json()).then(f=>{if(f.hasOwnProperty("errors"))append_to_output_and_scroll(c,f.errors[0].message);else{for(let g of f)a[parseInt(g.manga_id)]=parseInt(g.num_read_chapters);if(!e){if(300==f.length)return fetch_mal_manga_list(a,b,c,d+300);append_to_output_and_scroll(c,"Done fetching MyAnimeList manga.")}}}).catch(f=>{flash_background("mmd-not-saved"),console.error(f)}))}function fetch_mangadex_manga_list(a,b,c=1,d=1){return append_to_output_and_scroll(b,"Fetching MangaDex follow page manga "+c+(1<d?" of "+d:"")),fetch("https://mangadex.org/follows/manga/0/0/"+c+"/",{method:"GET",redirect:"follow",credentials:"include"}).then(e=>e.text()).then(e=>{for(let g,f=/href="\/title\/(\d+)\/.+"(?:\s*class)/g;null!==(g=f.exec(e));)g.index===f.lastIndex&&f.lastIndex++,a.push(parseInt(g[1]));if(1==c){let h=/Showing\s\d+\sto\s\d+\sof\s(\d+)\stitles/.exec(e);null!==h&&(d=Math.ceil(h[1]/100))}return c<d?fetch_mangadex_manga_list(a,b,c+1,d):void append_to_output_and_scroll(b,"Done fetching MangaDex follow manga.")}).catch(e=>{flash_background("mmd-not-saved"),console.error(e)})}async function update_all_manga_with_mal_data(a,b,c,d=0){return append_to_output_and_scroll(c,"Updating "+(d+1)+"/"+b.length),await new Promise(e=>{setTimeout(()=>{e()},500)}),fetch("https://mangadex.org/title/"+b[d],{method:"GET",cache:"no-cache"}).then(e=>e.text()).then(e=>{let f=/<title>(.+)\s*\(Title\)\s*-\s*MangaDex<\/title>/.exec(e)[1];append_to_output_and_scroll(c,"-> "+f);let g=/<a.+href='(.+)'>MyAnimeList<\/a>/.exec(e),h={name:f,id:b[d],mal:0,last:0,current:{volume:0,chapter:0},chapters:[]};if(null===g)return append_to_output_and_scroll(c,"-> Set to Chapter 0 (No MyAnimeList entry)"),update_manga_local_storage(h).then(()=>{return d++,d<b.length?update_all_manga_with_mal_data(a,b,c,d):void append_to_output_and_scroll(c,"Done. Refresh the page to see the new data.")});if(g=g[1],h.mal=parseInt(/.+\/(\d+)/.exec(g)[1]),h.mal in a&&(h.last=a[h.mal],current_options.save_all_opened)){let j=Math.max(h.last-current_options.max_save_opened,0);for(let k=h.last;k>j;k--)h.chapters.push(k)}return append_to_output_and_scroll(c,"-> Set to Chapter "+h.last),update_manga_local_storage(h).then(()=>{return d++,d<b.length?update_all_manga_with_mal_data(a,b,c,d):void append_to_output_and_scroll(c,"Done.")})}).catch(e=>{return flash_background("mmd-not-saved"),append_to_output_and_scroll(c,"Updating "+(d+1)+" Failed"),console.error(e),d++,d<b.length?update_all_manga_with_mal_data(a,b,c,d):void append_to_output_and_scroll(c,"Done.")})}async function importMAL(){let a=document.getElementById("mal-username").value,b=document.getElementById("mal-import-status");if(document.getElementById("mal-import").disabled=!0,""!=a){let c={},d=[];b.style.display="block",b.value="Starting... don't close this tab.",document.getElementById("import-panel").classList.remove("h-480"),document.getElementById("import-panel").classList.add("h-580"),await fetch_mal_manga_list(c,a,b,0,!0).then(async()=>{0==Object.keys(c).length?(flash_background("mmd-not-saved"),append_to_output_and_scroll(b,"Empty MAL manga list, aborting."),document.getElementById("mal-import").disabled=!1):(await fetch_mal_manga_list(c,a,b,Object.keys(c).length),await fetch_mangadex_manga_list(d,b),await update_all_manga_with_mal_data(c,d,b),flash_background("mmd-saved"),document.getElementById("mal-import").disabled=!1)})}else document.getElementById("mal-import").disabled=!1,flash_background("mmd-not-saved"),console.error("Empty MAL username")}document.addEventListener("DOMContentLoaded",()=>{restoreOptions().then(()=>{document.getElementById("save").addEventListener("click",saveOptions),document.getElementById("default_last_read").addEventListener("click",restoreDefault),document.getElementById("default_last_open").addEventListener("click",restoreDefault),document.getElementById("default_lower_chapter").addEventListener("click",restoreDefault),document.getElementById("default_opened_chapters").addEventListener("click",restoreDefault),document.getElementById("default_hide_lower").addEventListener("click",restoreDefault),document.getElementById("default_last_only_higher").addEventListener("click",restoreDefault),document.getElementById("default_max_save_opened").addEventListener("click",restoreDefault),document.getElementById("default_save_all_opened").addEventListener("click",restoreDefault),document.getElementById("default_auto_md_list").addEventListener("click",restoreDefault),document.getElementById("add-a-color").addEventListener("click",()=>{addColor()}),document.getElementById("last_read").addEventListener("input",a=>{changeColorBox(document.getElementById("box_last_read"),a.target.value)}),document.getElementById("lower_chapter").addEventListener("input",a=>{changeColorBox(document.getElementById("box_lower_chapter"),a.target.value)}),document.getElementById("opened_chapters").addEventListener("input",a=>{changeColorBox(document.getElementById("box_opened_chapters"),a.target.value)}),document.getElementById("open-export").addEventListener("click",a=>{openPanel(a),storage_get(null).then(b=>{document.getElementById("save-content").value=JSON.stringify(b)})}),document.getElementById("open-import").addEventListener("click",openPanel),document.getElementById("open-delete").addEventListener("click",openPanel),document.getElementById("delete-save").addEventListener("click",deleteSave),document.getElementById("save-content").addEventListener("click",a=>{a.target.select()}),document.getElementById("save-import").addEventListener("click",importMMD),document.getElementById("mal-import").addEventListener("click",importMAL)})});